<!DOCTYPE html>
<html lang="zh-TW">
<!--
    æ™®æ™®é¢¨ç­ç´šæ¦®è­½é»æ•¸ç³»çµ± V5.2 (Firebaseç‰ˆ)
    ä½œè€…ï¼šé˜¿å‰›è€å¸«
    æ”¹é€ è€…ï¼šGemini
    
    ç³»çµ±æ¨¡å¼èªªæ˜ï¼š
    1. å®¶é•·æ¨¡å¼ï¼ˆé è¨­ï¼‰ï¼šç›´æ¥é–‹å•ŸHTMLæ–‡ä»¶ï¼Œåƒ…èƒ½æŸ¥çœ‹å­¸ç”Ÿé»æ•¸ï¼Œç„¡æ³•ä¿®æ”¹
       - ç‰¹è‰²ï¼šé ‚éƒ¨ç¶ è‰²æ©«å¹…ã€ç¦ç”¨æ‰€æœ‰äº’å‹•åŠŸèƒ½ã€éš±è—ç®¡ç†æŒ‰éˆ•
       - é©åˆï¼šåˆ†äº«çµ¦å®¶é•·æŸ¥çœ‹å­©å­çš„é»æ•¸ç‹€æ³
    
    2. æ•™å¸«æ¨¡å¼ï¼šç¶²å€åŠ ä¸Š ?mode=teacher åƒæ•¸
       - ç‰¹è‰²ï¼šå®Œæ•´ç®¡ç†åŠŸèƒ½ã€å¯åŠ æ‰£åˆ†ã€ç®¡ç†å­¸ç”Ÿã€åŒ¯å‡ºæˆç¸¾ç­‰
       - é©åˆï¼šæ•™å¸«é€²è¡Œç­ç´šç®¡ç†
       - ç¯„ä¾‹ï¼šfile:///path/to/file.html?mode=teacher
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™®æ™®é¢¨ç­ç´šæ¦®è­½é»æ•¸ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* è‡ªå®šç¾© Pop Art é¢¨æ ¼ */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fef3c7; /* æº«æš–çš„é»ƒè‰²èƒŒæ™¯ */
        }
        .font-anton {
            font-family: 'Anton', sans-serif;
            letter-spacing: 0.05em;
        }
        .pop-shadow {
            box-shadow: 8px 8px 0px black;
        }
        .pop-shadow-sm {
            box-shadow: 4px 4px 0px black;
        }
        .pop-button {
            transition: all 0.15s ease-out;
        }
        .pop-button:hover {
            transform: translate(4px, 4px);
            box-shadow: 4px 4px 0px black;
        }
        .pop-button:active {
            transform: translate(8px, 8px);
            box-shadow: none;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
        .student-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .student-card:hover {
            transform: scale(1.05) rotate(-1deg);
            box-shadow: 12px 12px 0px rgba(0,0,0,0.8);
        }
        /* é»æ•¸å¢æ¸›å‹•ç•« */
        .point-change-up {
            animation: point-up 0.8s ease-out forwards;
        }
        .point-change-down {
            animation: point-down 0.8s ease-out forwards;
        }
        @keyframes point-up {
            0% { transform: translateY(0) scale(1); opacity: 1; color: #16a34a; } /* green-600 */
            100% { transform: translateY(-40px) scale(1.5); opacity: 0; }
        }
        @keyframes point-down {
            0% { transform: translateY(0) scale(1); opacity: 1; color: #dc2626; } /* red-600 */
            100% { transform: translateY(40px) scale(1.5); opacity: 0; }
        }
        /* åˆ†é æ¨£å¼ */
        .tab-button {
            transition: all 0.2s ease-out;
        }
        .tab-button:not(.active-tab):hover {
            transform: translateY(-2px);
        }
        .active-tab {
            background-color: #facc15 !important; /* yellow-400 */
            transform: translateY(-2px);
            box-shadow: 0 4px 0 black;
        }
        .group-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .group-card:hover {
            transform: scale(1.02) rotate(-0.5deg);
            box-shadow: 12px 12px 0px rgba(0,0,0,0.8);
        }
        /* å®¶é•·æ¨¡å¼æ¨£å¼ */
        .parent-mode .student-card,
        .parent-mode .group-card {
            cursor: default !important;
            pointer-events: none;
        }
        .parent-mode .student-card:hover,
        .parent-mode .group-card:hover {
            transform: none !important;
            box-shadow: 8px 8px 0px black !important;
        }
        .parent-mode-banner {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            border-bottom: 4px solid black;
        }
        .prose { max-width: 65ch; color: #374151; }
        .prose a { color: #4f46e5; text-decoration: underline; }
        .prose strong { color: #1f2937; font-weight: 600; }
        .prose ol { list-style-type: decimal; margin-left: 1.25rem; }
        .prose li { margin-top: 0.5rem; }
        .prose h4 { font-size: 1.25rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 1rem; }
        .prose pre { background-color: #e5e7eb; padding: 1rem; border-radius: 0.375rem; overflow-x: auto; }
        .prose code { font-family: monospace; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- ä¸»å®¹å™¨ -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- é ‚éƒ¨æ¨™é¡Œå’Œæ§åˆ¶æŒ‰éˆ• -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-baseline gap-x-3 md:gap-x-4">
                <h1 id="class-name-title" class="font-anton text-4xl md:text-6xl text-black drop-shadow-[4px_4px_0px_#facc15]">Classroom Points!</h1>
                <span class="font-normal text-gray-600 text-sm md:text-base whitespace-nowrap">(Made by é˜¿å‰›è€å¸«)</span>
            </div>
            <div class="flex items-center space-x-2 md:space-x-4">
                <button id="sort-btn" class="text-4xl hover:scale-110 transition-transform" title="ç›®å‰ï¼šæŒ‰å§“åæ’åºï¼Œé»æ“Šåˆ‡æ›ç‚ºæŒ‰åˆ†æ•¸æ’åº">â˜…</button>
                <button id="parent-link-btn" class="text-4xl hover:scale-110 transition-transform" title="ç”Ÿæˆå®¶é•·æª¢è¦–é€£çµ">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</button>
                <button id="teacher-panel-btn" class="text-4xl hover:scale-110 transition-transform">ğŸ§‘â€ğŸ«</button>
                <button id="help-btn" class="text-4xl hover:scale-110 transition-transform">â“</button>
            </div>
        </header>

        <!-- æ•™å¸«ç®¡ç†é¢æ¿ (é è¨­éš±è—) -->
        <div id="control-panel" class="bg-blue-400 border-4 border-black p-4 rounded-lg pop-shadow mb-8 flex-wrap gap-4 justify-center hidden">
            <button id="manage-student-btn" class="pop-button pop-shadow-sm bg-green-400 border-2 border-black rounded-md px-6 py-2 font-bold text-lg">ç®¡ç†å­¸ç”Ÿ</button>
            <button id="manage-avatars-btn" class="pop-button pop-shadow-sm bg-cyan-400 border-2 border-black rounded-md px-6 py-2 font-bold text-lg">ä¸Šå‚³é ­åƒ</button>
            <button id="manage-behaviors-btn" class="pop-button pop-shadow-sm bg-yellow-400 border-2 border-black rounded-md px-6 py-2 font-bold text-lg">ç®¡ç†è¡Œç‚º</button>
            <button id="export-grades-btn" class="pop-button pop-shadow-sm bg-purple-500 text-white border-2 border-black rounded-md px-6 py-2 font-bold text-lg">åŒ¯å‡ºæˆç¸¾</button>
            <button id="reset-points-btn" class="pop-button pop-shadow-sm bg-red-500 border-2 border-black rounded-md px-6 py-2 font-bold text-lg text-white">é‡è¨­é»æ•¸</button>
        </div>

        <!-- åˆ†é å°èˆª -->
        <div id="tabs-container" class="mb-8 hidden">
            <div class="flex border-b-4 border-black">
                <button id="students-tab" class="tab-button active-tab px-6 py-3 font-bold text-lg bg-yellow-400 border-4 border-black border-b-0 rounded-t-lg mr-2">å­¸ç”Ÿ</button>
                <button id="groups-tab" class="tab-button px-6 py-3 font-bold text-lg bg-gray-300 border-4 border-black border-b-0 rounded-t-lg hover:bg-gray-200">åˆ†çµ„</button>
            </div>
        </div>

        <!-- å­¸ç”Ÿæª¢è¦– -->
        <div id="students-view" class="tab-content">
            <div id="student-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <!-- å­¸ç”Ÿå¡ç‰‡å°‡æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
        </div>

        <!-- åˆ†çµ„æª¢è¦– -->
        <div id="groups-view" class="tab-content hidden">
            <div id="groups-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- åˆ†çµ„å¡ç‰‡å°‡æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
        </div>

        <!-- åˆå§‹æç¤º/è¼‰å…¥ç•«é¢ -->
        <div id="initial-prompt" class="text-center py-20">
            <p id="loading-text" class="text-2xl font-bold">æ­£åœ¨å¾ Firebase è¼‰å…¥è³‡æ–™...</p>
            <div id="spinner" class="animate-spin rounded-full h-12 w-12 border-b-4 border-black mx-auto mt-4"></div>
            <div id="setup-prompt" class="hidden mt-4 text-lg"></div>
        </div>

    </div>

    <!-- æ‰€æœ‰å½ˆå‡ºè¦–çª— (Modals) -->

    <!-- èªªæ˜ Modal -->
    <div id="help-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-3xl p-6 border-4 border-black rounded-lg pop-shadow flex flex-col" style="height: 90vh;">
            <h2 class="font-anton text-3xl mb-4 flex-shrink-0">Firebase è¨­å®šèªªæ˜</h2>
            <div class="prose max-w-none overflow-y-auto flex-grow pr-2">
                <h4>ç°¡ä»‹</h4>
                <p>æ–°ç‰ˆæœ¬ä½¿ç”¨ Google Firebase ä½œç‚ºå¾Œç«¯è³‡æ–™åº«ï¼Œå–ä»£äº†åŸæœ‰çš„ Google Sheetsï¼Œæä¾›æ›´å¿«é€Ÿã€æ›´å³æ™‚çš„è³‡æ–™åŒæ­¥é«”é©—ã€‚è¨­å®šéç¨‹å®Œå…¨å…è²»ï¼Œè«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œã€‚</p>

                <h4>æ­¥é©Ÿ 1ï¼šå»ºç«‹ Firebase å°ˆæ¡ˆ</h4>
                <ol>
                    <li>å‰å¾€ <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 font-bold">Firebase æ§åˆ¶å°</a>ã€‚</li>
                    <li>é»æ“Šã€Œå»ºç«‹å°ˆæ¡ˆã€ï¼Œä¸¦ç‚ºæ‚¨çš„å°ˆæ¡ˆå‘½åï¼ˆä¾‹å¦‚ï¼šã€Œç­ç´šé»æ•¸ç³»çµ±ã€ï¼‰ã€‚</li>
                    <li>æ‚¨å¯ä»¥é¸æ“‡æ˜¯å¦å•Ÿç”¨ Google Analytics (åˆ†æ)ï¼Œå°æ–¼æ­¤å·¥å…·ä¸¦éå¿…è¦ï¼Œå¯ä»¥é—œé–‰ä»¥ç°¡åŒ–è¨­å®šã€‚</li>
                    <li>é»æ“Šã€Œå»ºç«‹å°ˆæ¡ˆã€ä¸¦ç­‰å¾…å®Œæˆã€‚</li>
                </ol>

                <h4>æ­¥é©Ÿ 2ï¼šå»ºç«‹ Firestore è³‡æ–™åº«</h4>
                <ol>
                    <li>åœ¨æ‚¨çš„ Firebase å°ˆæ¡ˆé é¢ï¼Œé»æ“Šå·¦å´é¸å–®çš„ã€Œå»ºæ§‹ã€ > ã€ŒFirestore Databaseã€ã€‚</li>
                    <li>é»æ“Šã€Œå»ºç«‹è³‡æ–™åº«ã€ã€‚</li>
                    <li>é¸æ“‡ã€Œä»¥<strong>æ¸¬è©¦æ¨¡å¼</strong>å•Ÿå‹•ã€ã€‚é€™æœƒå…è¨±æˆ‘å€‘åœ¨åˆæœŸè®€å¯«è³‡æ–™ã€‚<strong>è­¦å‘Šï¼šæ¸¬è©¦æ¨¡å¼æœƒåœ¨30å¤©å¾Œåˆ°æœŸï¼Œå±†æ™‚éœ€è¦è¨­å®šæ›´å®‰å…¨çš„è¦å‰‡ã€‚</strong></li>
                    <li>é¸æ“‡é›¢æ‚¨æœ€è¿‘çš„ Cloud Firestore ä½ç½®ã€‚</li>
                    <li>é»æ“Šã€Œå•Ÿç”¨ã€ã€‚</li>
                </ol>

                <h4>æ­¥é©Ÿ 3ï¼šå–å¾— Firebase è¨­å®šæª” (firebaseConfig)</h4>
                <ol>
                    <li>åœ¨å°ˆæ¡ˆä¸»é ï¼Œé»æ“Šã€Œå°ˆæ¡ˆç¸½è¦½ã€æ—é‚Šçš„é½’è¼ªåœ–ç¤º âš™ï¸ï¼Œç„¶å¾Œé¸æ“‡ã€Œå°ˆæ¡ˆè¨­å®šã€ã€‚</li>
                    <li>åœ¨ã€Œæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ã€å€å¡Šï¼Œé»æ“Šç¶²é åœ–ç¤º ( <strong>&lt;/&gt;</strong> ) ä¾†è¨»å†Šä¸€å€‹æ–°çš„ç¶²é æ‡‰ç”¨ç¨‹å¼ã€‚</li>
                    <li>ç‚ºæ‚¨çš„æ‡‰ç”¨ç¨‹å¼å–ä¸€å€‹æš±ç¨±ï¼ˆä¾‹å¦‚ï¼šã€Œé»æ•¸ç³»çµ±ç¶²é ã€ï¼‰ï¼Œç„¶å¾Œé»æ“Šã€Œè¨»å†Šæ‡‰ç”¨ç¨‹å¼ã€ã€‚</li>
                    <li>è¨»å†Šå®Œæˆå¾Œï¼Œæ‚¨æœƒçœ‹åˆ°ä¸€å€‹åŒ…å« <code>firebaseConfig</code> ç‰©ä»¶çš„ç¨‹å¼ç¢¼å€å¡Šã€‚<strong>è«‹å®Œæ•´è¤‡è£½é€™å€‹ç‰©ä»¶</strong>ã€‚å®ƒçœ‹èµ·ä¾†åƒé€™æ¨£ï¼š
                        <pre><code>var firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "your-project-id.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project-id.appspot.com",
  messagingSenderId: "...",
  appId: "1:..."
};</code></pre>
                    </li>
                </ol>

                <h4>æ­¥é©Ÿ 4ï¼šè¨­å®šæœ¬ç¶²é </h4>
                <ol>
                    <li>ç”¨æ–‡å­—ç·¨è¼¯å™¨æ‰“é–‹é€™å€‹ HTML æª”æ¡ˆã€‚</li>
                    <li>åœ¨ç¨‹å¼ç¢¼ä¸­æ‰¾åˆ°ä¸€å€‹è¨»è§£ç‚ºã€Œ<strong>âœ¨âœ¨âœ¨ è«‹åœ¨é€™è£¡è²¼ä¸Šæ‚¨çš„ Firebase è¨­å®š âœ¨âœ¨âœ¨</strong>ã€çš„åœ°æ–¹ã€‚</li>
                    <li>å°‡æ‚¨å‰›å‰›è¤‡è£½çš„ <code>firebaseConfig</code> ç‰©ä»¶ï¼Œå®Œæ•´è²¼åˆ°æŒ‡å®šä½ç½®ï¼Œå–ä»£åŸæœ‰çš„ç¯„ä¾‹ã€‚</li>
                    <li>å„²å­˜æª”æ¡ˆä¸¦åœ¨ç€è¦½å™¨ä¸­é‡æ–°æ•´ç†ç¶²é ã€‚</li>
                    <li>å®Œæˆï¼ç³»çµ±æœƒè‡ªå‹•åœ¨æ‚¨çš„ Firestore è³‡æ–™åº«ä¸­å»ºç«‹æ‰€éœ€çš„è³‡æ–™é›†åˆ (collections) ä¸¦åŠ å…¥ç¯„ä¾‹è³‡æ–™ã€‚æ‚¨ç¾åœ¨å¯ä»¥é–‹å§‹ä½¿ç”¨äº†ï¼</li>
                </ol>
                
                <h4 style="color: #dc2626;">æ­¥é©Ÿ 5ï¼šè¨­å®šè³‡æ–™åº«å®‰å…¨è¦å‰‡ (é‡è¦ï¼)</h4>
                <p>æ‚¨åœ¨æ­¥é©Ÿ2ä¸­å•Ÿç”¨çš„ã€Œæ¸¬è©¦æ¨¡å¼ã€å°‡åœ¨ 30 å¤©å¾ŒéæœŸï¼Œå°è‡´è³‡æ–™åº«ç„¡æ³•å­˜å–ã€‚è«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿè¨­å®šæ°¸ä¹…è¦å‰‡ï¼Œä»¥ç¢ºä¿ç¨‹å¼å¯ä»¥æŒçºŒé‹ä½œã€‚</p>
                <ol>
                    <li>è¿”å›æ‚¨çš„ <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 font-bold">Firebase æ§åˆ¶å°</a>ã€‚</li>
                    <li>é»æ“Šå·¦å´é¸å–®çš„ã€Œå»ºæ§‹ã€ > ã€ŒFirestore Databaseã€ã€‚</li>
                    <li>é¸æ“‡ä¸Šæ–¹çš„ã€Œ<strong>è¦å‰‡</strong>ã€åˆ†é ã€‚</li>
                    <li>å°‡ç·¨è¼¯å™¨ä¸­ç¾æœ‰çš„æ‰€æœ‰æ–‡å­—åˆªé™¤ï¼Œä¸¦è²¼ä¸Šä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š</li>
                </ol>
                <div class="relative bg-gray-800 text-white p-4 rounded-md my-4">
                    <button id="copy-rules-code-btn" class="absolute top-2 right-2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded text-sm">è¤‡è£½</button>
                    <pre><code id="rules-code-block" class="text-sm whitespace-pre-wrap">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
</code></pre>
                </div>
                <ol start="5">
                    <li>é»æ“Šã€Œ<strong>ç™¼ä½ˆ</strong>ã€æŒ‰éˆ•ã€‚</li>
                </ol>
                <p class="p-3 bg-red-100 border-l-4 border-red-500 text-red-700 font-bold">
                    <strong>âš ï¸ å®‰å…¨è­¦å‘Šï¼š</strong>ä»¥ä¸Šè¦å‰‡å…è¨±ä»»ä½•äººè®€å–å’Œå¯«å…¥æ‚¨çš„è³‡æ–™åº«ã€‚é€™å°æ–¼è®“æ­¤å–®æ©Ÿ HTML æª”æ¡ˆæ­£å¸¸é‹ä½œæ˜¯å¿…è¦çš„ï¼Œä½†ä¹Ÿä»£è¡¨ä»»ä½•æ“æœ‰æ‚¨ Firebase è¨­å®šè³‡è¨Šçš„äººéƒ½èƒ½ä¿®æ”¹æ‚¨çš„è³‡æ–™ã€‚è«‹å‹¿åœ¨æ­¤ç³»çµ±ä¸­å„²å­˜ä»»ä½•æ•æ„Ÿæˆ–ç§å¯†çš„å­¸ç”Ÿå€‹è³‡ã€‚
                </p>

                <hr class="my-6 border-black">

                <h4>é™„éŒ„ï¼šå¸¸è¦‹éŒ¯èª¤æ’é™¤</h4>
                <p><strong>å•é¡Œï¼šé»æ“Šã€ŒæŸ¥çœ‹ç´€éŒ„ã€æ™‚æ²’æœ‰åæ‡‰æˆ–è·³å‡ºéŒ¯èª¤ã€‚</strong></p>
                <p><strong>åŸå› ï¼š</strong>é€™æ˜¯ç¬¬ä¸€æ¬¡æŸ¥è©¢æ­·å²ç´€éŒ„æ™‚æœƒç™¼ç”Ÿçš„æ­£å¸¸æƒ…æ³ã€‚Firebase éœ€è¦ç‚ºã€Œå­¸ç”ŸIDã€å’Œã€Œæ™‚é–“æˆ³ã€çš„çµ„åˆæŸ¥è©¢å»ºç«‹ä¸€å€‹ç´¢å¼•ï¼ˆå°±åƒæ›¸æœ¬çš„ç›®éŒ„ï¼‰ï¼Œæ‰èƒ½å¿«é€Ÿåœ°æ’åºèˆ‡å°‹æ‰¾è³‡æ–™ã€‚</p>
                <p><strong>è§£æ±ºæ–¹æ³•ï¼š</strong></p>
                <ol>
                    <li>åœ¨ç€è¦½å™¨ä¸­æŒ‰ä¸‹ <strong>F12</strong> éµæ‰“é–‹ã€Œé–‹ç™¼äººå“¡å·¥å…·ã€ï¼Œä¸¦åˆ‡æ›åˆ°ã€Œ<strong>Console (ä¸»æ§å°)</strong>ã€åˆ†é ã€‚</li>
                    <li>æ‚¨æ‡‰è©²æœƒçœ‹åˆ°ä¸€æ¢ä¾†è‡ª Firebase çš„éŒ¯èª¤è¨Šæ¯ï¼Œå…§å®¹åŒ…å« "The query requires an index"ã€‚</li>
                    <li>é€™æ¢éŒ¯èª¤è¨Šæ¯ä¸­æœƒåŒ…å«ä¸€å€‹<strong>å¯é»æ“Šçš„é€£çµ</strong>ï¼Œçœ‹èµ·ä¾†åƒé€™æ¨£ï¼š<code>https://console.firebase.google.com/v1/r/project/...</code></li>
                    <li><strong>é»æ“Šé‚£å€‹é€£çµ</strong>ã€‚å®ƒæœƒç›´æ¥å¸¶æ‚¨å‰å¾€ Firebase ç¶²ç«™çš„ç´¢å¼•å»ºç«‹é é¢ï¼Œä¸¦ä¸”æ‰€æœ‰éœ€è¦çš„è¨­å®šéƒ½å·²è‡ªå‹•å¡«å¥½ã€‚</li>
                    <li>åœ¨ Firebase é é¢ä¸­ï¼Œç›´æ¥é»æ“Šã€Œ<strong>å»ºç«‹ç´¢å¼•</strong>ã€æŒ‰éˆ•ã€‚</li>
                    <li>ç´¢å¼•å»ºç«‹éœ€è¦å¹¾åˆ†é˜çš„æ™‚é–“ã€‚æ‚¨å¯ä»¥åœ¨ Firebase ç¶²ç«™ä¸Šçœ‹åˆ°å»ºç«‹é€²åº¦ã€‚</li>
                    <li>ç´¢å¼•å»ºç«‹å®Œæˆå¾Œï¼Œå›åˆ°æœ¬é é¢é‡æ–°æ•´ç†ï¼Œã€ŒæŸ¥çœ‹ç´€éŒ„ã€åŠŸèƒ½ç¾åœ¨æ‡‰è©²å°±å¯ä»¥æ­£å¸¸é‹ä½œäº†ã€‚</li>
                </ol>
            </div>
            <div class="mt-4 text-right flex-shrink-0">
                <button id="close-help-btn" class="pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-2 font-bold">æˆ‘æ‡‚äº†ï¼</button>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å­¸ç”Ÿ Modal -->
    <div id="manage-student-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-green-300 w-full max-w-md p-6 border-4 border-black rounded-lg pop-shadow flex flex-col" style="height: 80vh;">
            <h2 class="font-anton text-3xl mb-4 flex-shrink-0">ç®¡ç†å­¸ç”Ÿ</h2>
            
            <!-- æ–°å¢å­¸ç”Ÿå€å¡Š -->
            <div class="mb-4 pb-4 border-b-2 border-black">
                <h3 class="font-bold text-xl mb-2">æ–°å¢å­¸ç”Ÿ</h3>
                <p class="mb-2 text-sm">è«‹è¼¸å…¥å­¸ç”Ÿå§“åï¼Œæ¯ä½å­¸ç”Ÿä½”ä¸€è¡Œã€‚å¯ä»¥åªè¼¸å…¥å§“åæˆ–ã€Œå§“åï¼Œåˆ†çµ„ã€çš„æ ¼å¼ã€‚</p>
                <textarea id="student-name-input" class="w-full h-24 p-2 border-2 border-black rounded-md mb-2" placeholder="ç‹å°æ˜
é™³å¤§è¯,ç¬¬ä¸€çµ„
æ—ç¾éº—	ç¬¬äºŒçµ„"></textarea>
                <button id="confirm-add-student-btn" class="w-full pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-2 font-bold">ç¢ºèªæ–°å¢</button>
            </div>

            <!-- åˆªé™¤å­¸ç”Ÿå€å¡Š -->
            <div class="flex-grow overflow-y-auto">
                 <h3 class="font-bold text-xl mb-2">åˆªé™¤å­¸ç”Ÿ</h3>
                 <div id="delete-student-list" class="space-y-2 pr-2">
                    <!-- å­¸ç”Ÿåˆ—è¡¨å°‡å‹•æ…‹æ’å…¥æ­¤è™• -->
                 </div>
            </div>

            <div class="mt-4 text-right flex-shrink-0">
                <button id="close-manage-student-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-6 py-2 font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- åŒ¯å‡ºæˆç¸¾ Modal -->
    <div id="export-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-teal-300 w-full max-w-sm p-6 border-4 border-black rounded-lg pop-shadow">
            <h2 class="font-anton text-3xl mb-4">åŒ¯å‡ºæˆç¸¾</h2>
            <p class="mb-6">è«‹é¸æ“‡åŒ¯å‡ºæ ¼å¼ï¼š</p>
            <div class="flex flex-col space-y-4">
                <button id="export-original-btn" class="pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-3 font-bold">æŒ‰åˆ†çµ„å§“åé †åºåŒ¯å‡º</button>
                <button id="export-sorted-btn" class="pop-button pop-shadow-sm bg-green-500 text-white border-2 border-black rounded-md px-6 py-3 font-bold">æŒ‰å¾—åˆ†é«˜ä½åŒ¯å‡º</button>
            </div>
            <div class="mt-6 text-right">
                <button id="cancel-export-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-6 py-2 font-bold">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- åŠ æ¸›åˆ† Modal -->
    <div id="points-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-purple-300 w-full max-w-lg p-6 border-4 border-black rounded-lg pop-shadow">
            <h2 id="points-modal-title" class="font-anton text-3xl mb-4 text-center">çµ¦äºˆé»æ•¸</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- åŠ åˆ†é …ç›® -->
                <div>
                    <h3 class="font-bold text-xl text-green-700 mb-2">åŠ åˆ†é …ç›®</h3>
                    <div id="positive-behaviors" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                </div>
                <!-- æ‰£åˆ†é …ç›® -->
                <div>
                    <h3 class="font-bold text-xl text-red-700 mb-2">å¾…æ”¹é€²é …ç›®</h3>
                    <div id="negative-behaviors" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                 <button id="view-history-btn" class="pop-button pop-shadow-sm bg-yellow-400 border-2 border-black rounded-md px-4 py-2 font-bold">æŸ¥çœ‹ç´€éŒ„</button>
                 <button id="close-points-modal-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-4 py-2 font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- æ­·å²ç´€éŒ„ Modal -->
    <div id="history-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-pink-300 w-full max-w-md p-6 border-4 border-black rounded-lg pop-shadow flex flex-col" style="height: 70vh;">
            <h2 id="history-modal-title" class="font-anton text-3xl mb-4 flex-shrink-0">æ­·å²ç´€éŒ„</h2>
            <div id="history-list" class="flex-grow overflow-y-auto bg-white/50 p-2 rounded-md border-2 border-black">
                <!-- ç´€éŒ„å°‡æ’å…¥æ­¤è™• -->
            </div>
            <div class="mt-4 text-right flex-shrink-0">
                <button id="close-history-modal-btn" class="pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-2 font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- ç®¡ç†è¡Œç‚º Modal -->
    <div id="manage-behaviors-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-orange-300 w-full max-w-2xl p-6 border-4 border-black rounded-lg pop-shadow flex flex-col" style="height: 80vh;">
            <h2 class="font-anton text-3xl mb-4 flex-shrink-0">ç®¡ç†è¡Œç‚ºé …ç›®</h2>
            <div class="flex-grow overflow-y-auto space-y-4" id="behavior-list-editor">
                <!-- è¡Œç‚ºç·¨è¼¯å™¨å°‡æ’å…¥æ­¤è™• -->
            </div>
            <div class="mt-4 pt-4 border-t-2 border-black flex-shrink-0 flex justify-between">
                <button id="add-new-behavior-btn" class="pop-button pop-shadow-sm bg-green-400 border-2 border-black rounded-md px-4 py-2 font-bold">æ–°å¢ä¸€é …</button>
                <div>
                    <button id="cancel-behaviors-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-6 py-2 font-bold">å–æ¶ˆ</button>
                    <button id="save-behaviors-btn" class="pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-2 font-bold">å„²å­˜è®Šæ›´</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å®¶é•·æ¨¡å¼é€£çµ Modal -->
    <div id="parent-link-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-green-300 w-full max-w-md p-6 border-4 border-black rounded-lg pop-shadow">
            <h2 class="font-anton text-3xl mb-4 text-center">å®¶é•·æª¢è¦–é€£çµ</h2>
            <div class="text-center mb-4">
                <p class="mb-2 font-bold">æƒæQRç¢¼æˆ–è¤‡è£½é€£çµåˆ†äº«çµ¦å®¶é•·ï¼š</p>
                <div id="qr-code-container" class="flex justify-center mb-4">
                    <canvas id="qr-canvas" class="border-2 border-black"></canvas>
                </div>
                <div class="bg-white border-2 border-black rounded-md p-3 mb-4">
                    <input type="text" id="parent-url-display" class="w-full text-sm text-center bg-transparent border-none outline-none" readonly>
                </div>
                <button id="copy-parent-url-btn" class="w-full pop-button pop-shadow-sm bg-blue-500 text-white border-2 border-black rounded-md px-6 py-3 font-bold mb-2">ğŸ“‹ è¤‡è£½é€£çµ</button>
                <p class="text-xs text-gray-600">å®¶é•·ä½¿ç”¨æ­¤é€£çµåªèƒ½æª¢è¦–ï¼Œç„¡æ³•ä¿®æ”¹é»æ•¸</p>
            </div>
            <div class="text-right">
                <button id="close-parent-link-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-6 py-2 font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- é ­åƒç®¡ç† Modal -->
    <div id="manage-avatars-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="bg-cyan-300 w-full max-w-4xl p-6 border-4 border-black rounded-lg pop-shadow flex flex-col" style="height: 80vh;">
            <h2 class="font-anton text-3xl mb-4 flex-shrink-0">å­¸ç”Ÿé ­åƒç®¡ç†</h2>
            <p class="text-sm mb-4 text-gray-700">é»æ“Šå­¸ç”Ÿé ­åƒå³å¯ä¸Šå‚³æ–°åœ–ç‰‡ï¼Œåœ–ç‰‡å°‡è‡ªå‹•å£“ç¸®ç‚ºå¯¬åº¦200px</p>
            
            <!-- å­¸ç”Ÿé ­åƒç¶²æ ¼ -->
            <div class="flex-grow overflow-y-auto">
                <div id="avatar-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- å­¸ç”Ÿé ­åƒå¡ç‰‡å°‡å‹•æ…‹æ’å…¥æ­¤è™• -->
                </div>
            </div>
            
            <!-- éš±è—çš„æ–‡ä»¶ä¸Šå‚³è¼¸å…¥ -->
            <input type="file" id="avatar-file-input" accept="image/*" class="hidden">
            
            <div class="mt-4 text-right flex-shrink-0">
                <button id="close-avatars-btn" class="pop-button pop-shadow-sm bg-gray-300 border-2 border-black rounded-md px-6 py-2 font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- å…ƒç´ é¸æ“‡ ---
        const getEl = (id) => document.getElementById(id);
        const app = {
            modals: {
                help: getEl('help-modal'),
                manageStudent: getEl('manage-student-modal'),
                manageAvatars: getEl('manage-avatars-modal'),
                export: getEl('export-modal'),
                points: getEl('points-modal'),
                history: getEl('history-modal'),
                manageBehaviors: getEl('manage-behaviors-modal'),
                parentLink: getEl('parent-link-modal'),
            },
            buttons: {
                sort: getEl('sort-btn'),
                teacherPanel: getEl('teacher-panel-btn'),
                parentLink: getEl('parent-link-btn'),
                help: getEl('help-btn'),
                closeHelp: getEl('close-help-btn'),
                manageStudent: getEl('manage-student-btn'),
                closeManageStudent: getEl('close-manage-student-btn'),
                confirmAddStudent: getEl('confirm-add-student-btn'),
                manageAvatars: getEl('manage-avatars-btn'),
                closeAvatars: getEl('close-avatars-btn'),
                exportGrades: getEl('export-grades-btn'),
                exportOriginal: getEl('export-original-btn'),
                exportSorted: getEl('export-sorted-btn'),
                cancelExport: getEl('cancel-export-btn'),
                closePoints: getEl('close-points-modal-btn'),
                viewHistory: getEl('view-history-btn'),
                closeHistory: getEl('close-history-modal-btn'),
                resetPoints: getEl('reset-points-btn'),
                manageBehaviors: getEl('manage-behaviors-btn'),
                saveBehaviors: getEl('save-behaviors-btn'),
                cancelBehaviors: getEl('cancel-behaviors-btn'),
                addNewBehavior: getEl('add-new-behavior-btn'),
                copyParentUrl: getEl('copy-parent-url-btn'),
                closeParentLink: getEl('close-parent-link-btn'),
                copyRulesCode: getEl('copy-rules-code-btn'), // æ–°å¢æŒ‰éˆ•
            },
            inputs: {
                studentName: getEl('student-name-input'),
                avatarFile: getEl('avatar-file-input'),
            },
            containers: {
                controlPanel: getEl('control-panel'),
                studentGrid: getEl('student-grid'),
                groupsGrid: getEl('groups-grid'),
                tabsContainer: getEl('tabs-container'),
                studentsView: getEl('students-view'),
                groupsView: getEl('groups-view'),
                studentsTab: getEl('students-tab'),
                groupsTab: getEl('groups-tab'),
                initialPrompt: getEl('initial-prompt'),
                loadingText: getEl('loading-text'),
                setupPrompt: getEl('setup-prompt'),
                spinner: getEl('spinner'),
                positiveBehaviors: getEl('positive-behaviors'),
                negativeBehaviors: getEl('negative-behaviors'),
                historyList: getEl('history-list'),
                behaviorListEditor: getEl('behavior-list-editor'),
                deleteStudentList: getEl('delete-student-list'),
                avatarGrid: getEl('avatar-grid'),
            },
            sounds: {
                positive: () => new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, release: 0.2 } }).toDestination().triggerAttackRelease("C5", "8n"),
                negative: () => new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.3, release: 0.3 } }).toDestination().triggerAttackRelease("A2", "8n"),
                click: () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2 }).toDestination().triggerAttackRelease("C2", "8n", Tone.now())
            },
            titles: {
                className: getEl('class-name-title'),
                pointsModal: getEl('points-modal-title'),
                historyModal: getEl('history-modal-title'),
            }
        };

        // --- æ¨¡å¼æª¢æ¸¬ï¼ˆé è¨­ç‚ºå®¶é•·æ¨¡å¼ï¼‰ ---
        const urlParams = new URLSearchParams(window.location.search);
        const isTeacherMode = urlParams.get('mode') === 'teacher';
        const isParentMode = !isTeacherMode;
        
        if (isParentMode) {
            document.body.classList.add('parent-mode');
            const banner = document.createElement('div');
            banner.className = 'parent-mode-banner';
            banner.textContent = 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶é•·æª¢è¦–æ¨¡å¼ - åƒ…ä¾›æŸ¥çœ‹ï¼Œç„¡æ³•ä¿®æ”¹';
            document.body.insertBefore(banner, document.body.firstChild);
        }

        // --- ç‹€æ…‹ç®¡ç† ---
        let state = {
            students: [],
            behaviors: [],
            groups: {},
            isLoading: true,
            currentStudentId: null,
            currentGroupName: null,
            className: 'Classroom Points!',
            sortOrder: 'byName', // 'byName', 'byPoints', or 'byGroup'
            activeTab: 'students', // 'students' or 'groups'
            isParentMode: isParentMode,
            isTeacherMode: isTeacherMode,
            currentUploadingStudentId: null,
            unsubscribeListeners: [] // å„²å­˜ç›£è½å™¨ä»¥ä¾›æ¸…ç†
        };

        // --- Firebase è¨­å®š ---
        // âœ¨âœ¨âœ¨ è«‹åœ¨é€™è£¡è²¼ä¸Šæ‚¨çš„ Firebase è¨­å®š âœ¨âœ¨âœ¨
        // å¾ Firebase å°ˆæ¡ˆè¨­å®šä¸­è¤‡è£½æ‚¨çš„ firebaseConfig ç‰©ä»¶ä¸¦è²¼åˆ°æ­¤è™•
        const firebaseConfig = {
  apiKey: "AIzaSyCyW3P6Xekwf_DLndgZt4o21sVMla_5BJw",
  authDomain: "ckesclassdojo.firebaseapp.com",
  projectId: "ckesclassdojo",
  storageBucket: "ckesclassdojo.firebasestorage.app",
  messagingSenderId: "613646301956",
  appId: "1:613646301956:web:6b1a37196ce3b591e8ee51"
        };
        // âœ¨âœ¨âœ¨ END OF Firebase è¨­å®š âœ¨âœ¨âœ¨

        // --- é€šç”¨å‡½å¼ ---
        const toggleModal = (modal, show) => {
            modal.classList.toggle('hidden', !show);
        };

        const playSound = (soundPlayer) => {
            if (typeof Tone === 'undefined') return;
            if (Tone.context.state !== 'running') {
                Tone.start().catch(e => console.error("Tone.js context ç„¡æ³•å•Ÿå‹•", e));
            }
            try {
                soundPlayer();
            } catch (e) {
                console.error("éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", e);
            }
        };

        const exportToCsv = (studentData, filename) => {
            let csvContent = "data:text/csv;charset=utf-8,ï»¿"; // BOM for Excel
            csvContent += "åˆ†çµ„,å­¸ç”Ÿå§“å,ç¸½å¾—åˆ†\n";
            studentData.forEach(student => {
                const group = student.group || 'æœªåˆ†çµ„';
                csvContent += `"${group}","${student.name}",${student.points}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- æ¸²æŸ“å‡½å¼ ---
        const setLoading = (isLoading) => {
            state.isLoading = isLoading;
            const hasStudents = state.students && state.students.length > 0;
            app.containers.initialPrompt.classList.toggle('hidden', !isLoading && hasStudents);
            if (isLoading) {
                app.containers.loadingText.textContent = "æ­£åœ¨å¾ Firebase è¼‰å…¥è³‡æ–™...";
                app.containers.spinner.classList.remove('hidden');
                app.containers.setupPrompt.classList.add('hidden');
            }
        };
        
        const generateAvatar = (seed) => {
            const S = (s) => { let h = 0; for(let i=0; i<s.length; i++) h = (Math.imul(31, h) + s.charCodeAt(i)) | 0; return h; };
            const R = (s) => { s = Math.sin(s) * 10000; return s - Math.floor(s); };
            const seedNum = S(seed);
            
            const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'];
            const bgColor = colors[Math.floor(R(seedNum) * colors.length)];
            const eyeType = Math.floor(R(seedNum+1) * 3);
            const mouthType = Math.floor(R(seedNum+2) * 3);
            
            let eyes = '';
            if (eyeType === 0) eyes = `<circle cx="35" cy="40" r="8" fill="white"/><circle cx="35" cy="40" r="4" fill="black"/><circle cx="65" cy="40" r="8" fill="white"/><circle cx="65" cy="40" r="4" fill="black"/>`;
            else if (eyeType === 1) eyes = `<rect x="28" y="35" width="15" height="10" fill="white" transform="rotate(-10 35 40)"/><rect x="60" y="35" width="15" height="10" fill="white" transform="rotate(10 65 40)"/>`;
            else eyes = `<path d="M30 45 C 35 35, 45 35, 50 45" stroke="white" stroke-width="6" fill="none"/><path d="M55 45 C 60 35, 70 35, 75 45" stroke="white" stroke-width="6" fill="none"/>`;

            let mouth = '';
            if (mouthType === 0) mouth = `<path d="M35 70 Q 50 85, 65 70" stroke="white" stroke-width="5" fill="none"/>`;
            else if (mouthType === 1) mouth = `<rect x="40" y="70" width="20" height="8" fill="white" rx="3"/>`;
            else mouth = `<circle cx="50" cy="75" r="10" fill="white"/>`;

            return `data:image/svg+xml,${encodeURIComponent(`<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" rx="20" fill="${bgColor}" />${eyes}${mouth}</svg>`)}`;
        };

        const switchTab = (tabName) => {
            state.activeTab = tabName;
            app.containers.studentsTab.classList.toggle('active-tab', tabName === 'students');
            app.containers.groupsTab.classList.toggle('active-tab', tabName === 'groups');
            app.containers.studentsTab.style.backgroundColor = tabName === 'students' ? '#facc15' : '#d1d5db';
            app.containers.groupsTab.style.backgroundColor = tabName === 'groups' ? '#facc15' : '#d1d5db';
            app.containers.studentsView.classList.toggle('hidden', tabName !== 'students');
            app.containers.groupsView.classList.toggle('hidden', tabName !== 'groups');
            if (tabName === 'groups') renderGroupsGrid();
        };

        const renderStudentGrid = () => {
            if (!state.students) return;
            app.containers.studentGrid.innerHTML = '';
            if (state.students.length === 0 && !state.isLoading) {
                 app.containers.initialPrompt.classList.remove('hidden');
                 app.containers.loadingText.textContent = "ç­ç´šè£¡é‚„æ²’æœ‰å­¸ç”Ÿå–”ï¼";
                 app.containers.setupPrompt.innerHTML = `<p class="mt-2">è«‹é»æ“Š ğŸ§‘â€ğŸ« æŒ‰éˆ•ï¼Œç„¶å¾Œé¸æ“‡ã€Œç®¡ç†å­¸ç”Ÿã€ä¾†æ–°å¢ç¬¬ä¸€æ‰¹å­¸ç”Ÿã€‚</p>`;
                 app.containers.spinner.classList.add('hidden');
                 return;
            }
            
            let sortedStudents = [...state.students];
            if (state.sortOrder === 'byName') {
                sortedStudents.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            } else if (state.sortOrder === 'byPoints') {
                sortedStudents.sort((a, b) => b.points - a.points);
            } else if (state.sortOrder === 'byGroup') {
                sortedStudents.sort((a, b) => {
                    const groupA = a.group || 'ï¿¿';
                    const groupB = b.group || 'ï¿¿';
                    if (groupA === groupB) return a.name.localeCompare(b.name, 'zh-Hant');
                    return groupA.localeCompare(groupB, 'zh-Hant');
                });
            }
            
            sortedStudents.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card bg-white border-4 border-black rounded-lg p-3 flex flex-col items-center cursor-pointer pop-shadow relative';
                card.dataset.studentId = student.id;

                const pointChangeEl = document.createElement('div');
                pointChangeEl.className = 'point-change-indicator absolute text-3xl font-anton font-bold pointer-events-none opacity-0';
                
                const avatar = document.createElement('img');
                avatar.src = student.avatar || generateAvatar(student.name);
                avatar.alt = `${student.name} çš„é ­åƒ`;
                avatar.className = 'w-24 h-24 rounded-md border-2 border-black mb-2 object-cover';

                const nameContainer = document.createElement('div');
                nameContainer.className = 'text-center w-full';
                
                if (student.group) {
                    nameContainer.innerHTML = `<p class="font-bold text-lg truncate"><span class="text-sm text-gray-600 font-normal">${student.group}</span><span class="ml-1">${student.name}</span></p>`;
                } else {
                    nameContainer.innerHTML = `<p class="font-bold text-center text-lg truncate w-full">${student.name}</p>`;
                }

                const points = document.createElement('p');
                points.className = 'font-anton text-4xl text-blue-600';
                points.textContent = student.points;
                points.id = `points-${student.id}`;
                
                card.append(pointChangeEl, avatar, nameContainer, points);
                card.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    openPointsModal(student.id);
                });
                app.containers.studentGrid.appendChild(card);
            });
        };

        const renderGroupsGrid = () => {
            app.containers.groupsGrid.innerHTML = '';
            const groups = {};
            state.students.forEach(student => {
                const groupName = student.group || 'æœªåˆ†çµ„';
                if (!groups[groupName]) groups[groupName] = [];
                groups[groupName].push(student);
            });
            
            if (Object.keys(groups).length === 0 || (Object.keys(groups).length === 1 && groups['æœªåˆ†çµ„'])) {
                app.containers.groupsGrid.innerHTML = '<p class="text-center text-gray-600 p-8 col-span-full">æ²’æœ‰åˆ†çµ„è³‡æ–™ã€‚è«‹åœ¨ç®¡ç†å­¸ç”Ÿæ™‚ï¼Œä½¿ç”¨ã€Œå§“å,åˆ†çµ„ã€æ ¼å¼ä¾†è¨­å®šåˆ†çµ„ã€‚</p>';
                return;
            }
            
            const groupColors = ['from-pink-300 to-purple-300', 'from-blue-300 to-indigo-300', 'from-green-300 to-teal-300', 'from-yellow-300 to-orange-300', 'from-red-300 to-pink-300', 'from-purple-300 to-violet-300', 'from-cyan-300 to-blue-300', 'from-lime-300 to-green-300'];
            
            Object.entries(groups).forEach(([groupName, students], index) => {
                if (groupName === 'æœªåˆ†çµ„' && Object.keys(groups).length > 1) return;
                const groupCard = document.createElement('div');
                const colorClass = groupColors[index % groupColors.length];
                groupCard.className = `group-card bg-gradient-to-br ${colorClass} border-4 border-black rounded-lg p-4 cursor-pointer pop-shadow`;
                
                const totalPoints = students.reduce((sum, s) => sum + s.points, 0);
                const avgPoints = students.length > 0 ? Math.round(totalPoints / students.length) : 0;
                
                let studentListHtml = '';
                students.forEach(student => {
                    studentListHtml += `<div class="flex justify-between items-center py-1 px-2 bg-white/30 rounded mb-1"><span class="font-bold">${student.name}</span><span class="font-anton text-lg text-blue-600">${student.points}</span></div>`;
                });

                groupCard.innerHTML = `
                    <h3 class="font-anton text-2xl mb-3 text-center">${groupName}</h3>
                    <div class="mb-3">${studentListHtml}</div>
                    <div class="text-center border-t-2 border-black pt-2">
                        <p class="text-sm"><span class="font-bold">äººæ•¸:</span> ${students.length}</p>
                        <p class="text-sm"><span class="font-bold">ç¸½åˆ†:</span> ${totalPoints}</p>
                        <p class="text-sm"><span class="font-bold">å¹³å‡:</span> ${avgPoints}</p>
                    </div>
                `;
                groupCard.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    openGroupPointsModal(groupName, students);
                });
                app.containers.groupsGrid.appendChild(groupCard);
            });
        };
        
        const renderStudentDeletionList = () => {
            app.containers.deleteStudentList.innerHTML = '';
            if (state.students.length === 0) {
                app.containers.deleteStudentList.innerHTML = '<p class="text-center text-gray-600 p-4">ç›®å‰æ²’æœ‰å­¸ç”Ÿå¯åˆªé™¤ã€‚</p>';
                return;
            }
            
            let sortedStudents = [...state.students].sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            sortedStudents.forEach(student => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white/50 p-2 rounded-md';
                item.innerHTML = `<span class="font-bold">${student.name}</span><button data-id="${student.id}" class="delete-student-btn pop-button bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-md border-2 border-black">åˆªé™¤</button>`;
                app.containers.deleteStudentList.appendChild(item);
            });
            
            document.querySelectorAll('.delete-student-btn').forEach(button => {
                button.addEventListener('click', handleDeleteStudent);
            });
        };

        // --- Modal é–‹å•Ÿ/é—œé–‰é‚è¼¯ ---
        const openManageStudentModal = () => {
            playSound(app.sounds.click);
            app.inputs.studentName.value = '';
            renderStudentDeletionList();
            toggleModal(app.modals.manageStudent, true);
            app.inputs.studentName.focus();
        };

        const openGroupPointsModal = (groupName, students) => {
            if (!state.isTeacherMode) return;
            state.currentGroupName = groupName;
            state.currentStudentId = null;
            app.titles.pointsModal.textContent = `çµ¦ ${groupName} é»æ•¸`;
            
            app.containers.positiveBehaviors.innerHTML = '';
            app.containers.negativeBehaviors.innerHTML = '';
            state.behaviors.forEach(b => {
                const btn = document.createElement('button');
                const pointsText = b.points > 0 ? `+${b.points}` : b.points;
                btn.className = `w-full pop-button pop-shadow-sm border-2 border-black rounded-md p-3 font-bold text-left flex justify-between items-center ${b.type === 'positive' ? 'bg-green-400' : 'bg-red-400'}`;
                btn.innerHTML = `<span>${b.name}</span> <span class="text-xl">${pointsText}</span>`;
                btn.addEventListener('click', () => awardGroupPoints(b, students));
                if (b.type === 'positive') app.containers.positiveBehaviors.appendChild(btn);
                else app.containers.negativeBehaviors.appendChild(btn);
            });
            
            app.buttons.viewHistory.style.display = 'none';
            toggleModal(app.modals.points, true);
        };

        const openPointsModal = (studentId) => {
            if (!state.isTeacherMode) return;
            state.currentStudentId = studentId;
            state.currentGroupName = null;
            const student = state.students.find(s => s.id === studentId);
            if (!student) return;

            app.titles.pointsModal.textContent = `çµ¦ ${student.name} é»æ•¸`;
            app.buttons.viewHistory.style.display = 'inline-block';
            
            app.containers.positiveBehaviors.innerHTML = '';
            app.containers.negativeBehaviors.innerHTML = '';
            state.behaviors.forEach(b => {
                const btn = document.createElement('button');
                const pointsText = b.points > 0 ? `+${b.points}` : b.points;
                btn.className = `w-full pop-button pop-shadow-sm border-2 border-black rounded-md p-3 font-bold text-left flex justify-between items-center ${b.type === 'positive' ? 'bg-green-400' : 'bg-red-400'}`;
                btn.innerHTML = `<span>${b.name}</span> <span class="text-xl">${pointsText}</span>`;
                btn.addEventListener('click', () => awardPoints(b));
                if (b.type === 'positive') app.containers.positiveBehaviors.appendChild(btn);
                else app.containers.negativeBehaviors.appendChild(btn);
            });
            toggleModal(app.modals.points, true);
        };

        const openHistoryModal = async () => {
            const student = state.students.find(s => s.id === state.currentStudentId);
            app.titles.historyModal.textContent = `${student.name} çš„æ­·å²ç´€éŒ„`;
            app.containers.historyList.innerHTML = '<p>è¼‰å…¥ä¸­...</p>';
            toggleModal(app.modals.history, true);
            
            try {
                const snapshot = await db.collection('logs')
                    .where('studentId', '==', state.currentStudentId)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const history = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { ...data, timestamp: data.timestamp ? data.timestamp.toDate().toLocaleString('zh-TW') : 'N/A' };
                });

                app.containers.historyList.innerHTML = '';
                if (history.length === 0) {
                    app.containers.historyList.innerHTML = '<p class="text-center p-4">æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚</p>';
                    return;
                }
                history.forEach(log => {
                    const item = document.createElement('div');
                    item.className = `p-2 rounded-md mb-2 flex justify-between items-center ${log.points > 0 ? 'bg-green-200' : 'bg-red-200'}`;
                    const pointsText = log.points > 0 ? `+${log.points}` : log.points;
                    item.innerHTML = `<div><p class="font-bold">${log.behaviorName}</p><p class="text-sm text-gray-600">${log.timestamp}</p></div><p class="font-anton text-2xl ${log.points > 0 ? 'text-green-700' : 'text-red-700'}">${pointsText}</p>`;
                    app.containers.historyList.appendChild(item);
                });
            } catch (error) {
                console.error("è®€å–æ­·å²ç´€éŒ„å¤±æ•—:", error);
                app.containers.historyList.innerHTML = '<p class="text-center p-4">è®€å–ç´€éŒ„å¤±æ•—ã€‚</p>';
            }
        };

        const openManageBehaviorsModal = () => {
            app.containers.behaviorListEditor.innerHTML = '';
            state.behaviors.forEach((b, index) => addBehaviorEditorRow(b, index));
            toggleModal(app.modals.manageBehaviors, true);
        };

        const addBehaviorEditorRow = (behavior = { name: '', points: 1, type: 'positive' }, index) => {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 p-2 bg-white/60 rounded-md border-2 border-black';
            div.innerHTML = `
                <input type="text" value="${behavior.name}" class="behavior-name-input flex-grow p-2 border-2 border-black rounded-md" placeholder="è¡Œç‚ºåç¨±">
                <input type="number" value="${behavior.points}" class="behavior-points-input w-20 p-2 border-2 border-black rounded-md" placeholder="é»æ•¸">
                <select class="behavior-type-select p-2 border-2 border-black rounded-md bg-white">
                    <option value="positive" ${behavior.type === 'positive' ? 'selected' : ''}>åŠ åˆ†</option>
                    <option value="negative" ${behavior.type === 'negative' ? 'selected' : ''}>æ‰£åˆ†</option>
                </select>
                <button class="remove-behavior-btn text-red-600 font-bold text-2xl p-1 hover:bg-red-200 rounded-full">âœ–</button>
            `;
            app.containers.behaviorListEditor.appendChild(div);
            div.querySelector('.remove-behavior-btn').addEventListener('click', () => div.remove());
        };

        // --- åœ–ç‰‡å£“ç¸®åŠŸèƒ½ ---
        const compressImage = (file, maxWidth = 200) => {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    const ratio = Math.min(maxWidth / img.width, 1); // Only scale down
                    const newWidth = img.width * ratio;
                    const newHeight = img.height * ratio;
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = URL.createObjectURL(file);
            });
        };

        // --- é ­åƒç®¡ç†åŠŸèƒ½ ---
        const openAvatarsModal = () => {
            playSound(app.sounds.click);
            renderAvatarGrid();
            toggleModal(app.modals.manageAvatars, true);
        };

        const renderAvatarGrid = () => {
            app.containers.avatarGrid.innerHTML = '';
            if (state.students.length === 0) {
                app.containers.avatarGrid.innerHTML = '<p class="text-center text-gray-600 p-8 col-span-full">ç›®å‰æ²’æœ‰å­¸ç”Ÿè³‡æ–™ã€‚</p>';
                return;
            }
            const sortedStudents = [...state.students].sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            sortedStudents.forEach(student => {
                const avatarCard = document.createElement('div');
                avatarCard.className = 'bg-white border-2 border-black rounded-lg p-3 text-center cursor-pointer hover:bg-gray-50 transition-colors';
                avatarCard.innerHTML = `
                    <div class="relative mb-2">
                        <img src="${student.avatar || generateAvatar(student.name)}" alt="${student.name}" class="w-16 h-16 mx-auto rounded-md border-2 border-gray-300 object-cover">
                        <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-0 hover:bg-opacity-30 transition-all rounded-md">
                            <span class="text-white text-xs opacity-0 hover:opacity-100">é»æ“Šä¸Šå‚³</span>
                        </div>
                    </div>
                    <p class="font-bold text-sm">${student.name}</p>
                    <p class="text-xs text-gray-500">${student.group || 'æœªåˆ†çµ„'}</p>
                `;
                avatarCard.addEventListener('click', () => {
                    state.currentUploadingStudentId = student.id;
                    app.inputs.avatarFile.click();
                });
                app.containers.avatarGrid.appendChild(avatarCard);
            });
        };

        // --- äº‹ä»¶è™•ç† ---
        const handleAddStudents = async () => {
            const lines = app.inputs.studentName.value.trim().split('\n').map(n => n.trim()).filter(n => n);
            if (lines.length === 0) {
                alert('è«‹è‡³å°‘è¼¸å…¥ä¸€ä½å­¸ç”Ÿå§“åï¼');
                return;
            }
            playSound(app.sounds.click);
            const batch = db.batch();
            const studentsPayload = lines.map(line => {
                let name, group = '';
                const separator = line.includes(',') ? ',' : (line.includes('\t') ? '\t' : null);
                if (separator) {
                    [name, group] = line.split(separator).map(s => s.trim());
                } else {
                    name = line;
                }
                return { name, group: group || '', avatar: generateAvatar(name), points: 0 };
            });

            studentsPayload.forEach(student => {
                const docRef = db.collection('students').doc();
                batch.set(docRef, student);
            });

            try {
                await batch.commit();
                app.inputs.studentName.value = '';
                alert(`${lines.length} ä½å­¸ç”Ÿå·²æˆåŠŸæ–°å¢ï¼`);
                if (studentsPayload.some(s => s.group)) {
                    app.containers.tabsContainer.classList.remove('hidden');
                }
            } catch (error) {
                console.error("æ–°å¢å­¸ç”Ÿå¤±æ•—:", error);
                alert("æ–°å¢å­¸ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤è¨Šæ¯ã€‚");
            }
        };
        
        const handleDeleteStudent = async (event) => {
            const studentId = event.target.dataset.id;
            const student = state.students.find(s => s.id === studentId);
            if (!student) return;

            playSound(app.sounds.negative);
            if (confirm(`ç¢ºå®šè¦åˆªé™¤å­¸ç”Ÿã€Œ${student.name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                try {
                    await db.collection('students').doc(studentId).delete();
                    alert(`å­¸ç”Ÿã€Œ${student.name}ã€å·²åˆªé™¤ã€‚`);
                } catch (error) {
                    console.error("åˆªé™¤å­¸ç”Ÿå¤±æ•—:", error);
                    alert("åˆªé™¤å­¸ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤è¨Šæ¯ã€‚");
                }
            }
        };

        const awardPoints = async (behavior) => {
            const { name, points } = behavior;
            playSound(points > 0 ? app.sounds.positive : app.sounds.negative);
            toggleModal(app.modals.points, false);

            const studentCard = document.querySelector(`[data-student-id="${state.currentStudentId}"]`);
            if(studentCard) {
                const indicator = studentCard.querySelector('.point-change-indicator');
                indicator.textContent = points > 0 ? `+${points}` : points;
                indicator.className = 'point-change-indicator absolute text-3xl font-anton font-bold pointer-events-none opacity-0';
                void indicator.offsetWidth;
                indicator.classList.add(points > 0 ? 'point-change-up' : 'point-change-down');
            }

            const studentRef = db.collection('students').doc(state.currentStudentId);
            const logRef = db.collection('logs').doc();
            try {
                const batch = db.batch();
                batch.update(studentRef, { points: firebase.firestore.FieldValue.increment(Number(points)) });
                batch.set(logRef, {
                    studentId: state.currentStudentId,
                    studentName: state.students.find(s => s.id === state.currentStudentId).name,
                    behaviorName: name,
                    points: Number(points),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                await batch.commit();
            } catch (error) {
                console.error("æ›´æ–°é»æ•¸å¤±æ•—:", error);
                alert("æ›´æ–°é»æ•¸å¤±æ•—ï¼Œè³‡æ–™å°‡ä¸æœƒè®Šæ›´ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–Firebaseè¨­å®šã€‚");
            }
        };

        const awardGroupPoints = async (behavior, students) => {
            const { name, points } = behavior;
            playSound(points > 0 ? app.sounds.positive : app.sounds.negative);
            toggleModal(app.modals.points, false);

            const successToast = document.createElement('div');
            successToast.className = 'fixed top-4 right-4 bg-green-400 border-2 border-black text-white p-3 rounded-lg font-bold z-50';
            successToast.textContent = `å·²ç‚º ${state.currentGroupName} çš„ ${students.length} ä½å­¸ç”ŸåŠ æ‰£ ${points > 0 ? '+' : ''}${points} åˆ†ï¼`;
            document.body.appendChild(successToast);
            setTimeout(() => document.body.removeChild(successToast), 3000);

            const batch = db.batch();
            students.forEach(student => {
                const studentRef = db.collection('students').doc(student.id);
                batch.update(studentRef, { points: firebase.firestore.FieldValue.increment(Number(points)) });
                const logRef = db.collection('logs').doc();
                batch.set(logRef, {
                    studentId: student.id,
                    studentName: student.name,
                    behaviorName: `[åˆ†çµ„] ${name}`,
                    points: Number(points),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            try {
                await batch.commit();
            } catch (error) {
                console.error("åˆ†çµ„æ›´æ–°é»æ•¸å¤±æ•—:", error);
                alert("åˆ†çµ„æ›´æ–°é»æ•¸å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°ã€‚");
            }
        };

        const handleResetPoints = async () => {
            playSound(app.sounds.negative);
            if (confirm('ç¢ºå®šè¦å°‡æ‰€æœ‰å­¸ç”Ÿçš„é»æ•¸é‡è¨­ç‚º 0 å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                const batch = db.batch();
                state.students.forEach(student => {
                    const studentRef = db.collection('students').doc(student.id);
                    batch.update(studentRef, { points: 0 });
                });
                const logRef = db.collection('logs').doc();
                batch.set(logRef, {
                    studentId: 'SYSTEM',
                    behaviorName: 'æ‰€æœ‰é»æ•¸å·²é‡è¨­',
                    points: 0,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                try {
                    await batch.commit();
                    alert('æ‰€æœ‰å­¸ç”Ÿçš„é»æ•¸å·²æˆåŠŸé‡è¨­ç‚º 0ï¼');
                } catch (error) {
                    console.error("é‡è¨­é»æ•¸å¤±æ•—:", error);
                    alert("é‡è¨­é»æ•¸å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°ã€‚");
                }
            }
        };

        const handleSaveBehaviors = async () => {
            const behaviorElements = app.containers.behaviorListEditor.querySelectorAll('.flex.items-center.gap-2');
            const newBehaviors = [];
            let isValid = true;
            behaviorElements.forEach(el => {
                const name = el.querySelector('.behavior-name-input').value.trim();
                const points = el.querySelector('.behavior-points-input').value;
                const type = el.querySelector('.behavior-type-select').value;
                if (name && points) {
                    newBehaviors.push({ name, points: Number(points), type });
                } else {
                    isValid = false;
                }
            });

            if (!isValid) {
                alert('æ‰€æœ‰è¡Œç‚ºéƒ½å¿…é ˆæœ‰åç¨±å’Œé»æ•¸ã€‚');
                return;
            }

            try {
                const batch = db.batch();
                const snapshot = await db.collection('behaviors').get();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                newBehaviors.forEach(b => {
                    const docRef = db.collection('behaviors').doc();
                    batch.set(docRef, b);
                });
                await batch.commit();
                toggleModal(app.modals.manageBehaviors, false);
                alert('è¡Œç‚ºé …ç›®å·²æ›´æ–°ï¼');
            } catch (error) {
                console.error("å„²å­˜è¡Œç‚ºå¤±æ•—:", error);
                alert("å„²å­˜è¡Œç‚ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°ã€‚");
            }
        };

        const handleAvatarUpload = async (event) => {
            const file = event.target.files[0];
            if (!file || !state.currentUploadingStudentId) return;
            const student = state.students.find(s => s.id === state.currentUploadingStudentId);
            if (!student) return;
            
            const uploadToast = document.createElement('div');
            uploadToast.className = 'fixed top-4 right-4 bg-blue-400 border-2 border-black text-white p-3 rounded-lg font-bold z-50';
            uploadToast.textContent = `æ­£åœ¨ç‚º ${student.name} ä¸Šå‚³é ­åƒ...`;
            document.body.appendChild(uploadToast);
            
            try {
                const compressedImage = await compressImage(file, 200);
                await db.collection('students').doc(state.currentUploadingStudentId).update({ avatar: compressedImage });
                document.body.removeChild(uploadToast);
                const successToast = document.createElement('div');
                successToast.className = 'fixed top-4 right-4 bg-green-400 border-2 border-black text-white p-3 rounded-lg font-bold z-50';
                successToast.textContent = `${student.name} çš„é ­åƒå·²æ›´æ–°ï¼`;
                document.body.appendChild(successToast);
                setTimeout(() => document.body.removeChild(successToast), 3000);
            } catch (error) {
                console.error('é ­åƒä¸Šå‚³å¤±æ•—:', error);
                document.body.removeChild(uploadToast);
                const errorToast = document.createElement('div');
                errorToast.className = 'fixed top-4 right-4 bg-red-400 border-2 border-black text-white p-3 rounded-lg font-bold z-50';
                errorToast.textContent = `${student.name} é ­åƒä¸Šå‚³å¤±æ•—`;
                document.body.appendChild(errorToast);
                setTimeout(() => document.body.removeChild(errorToast), 3000);
            }
            event.target.value = '';
            state.currentUploadingStudentId = null;
        };

        const generateParentLink = () => window.location.href.split('?')[0];

        const openParentLinkModal = () => {
            playSound(app.sounds.click);
            const parentUrl = generateParentLink();
            getEl('parent-url-display').value = parentUrl;
            const canvas = getEl('qr-canvas');
            try {
                if (typeof qrcode === 'undefined') throw new Error('QRç¢¼åº«æœªè¼‰å…¥');
                const qr = qrcode(0, 'M');
                qr.addData(parentUrl);
                qr.make();
                canvas.width = 200;
                canvas.height = 200;
                qr.renderTo2dContext(canvas.getContext('2d'), 5);
            } catch (error) {
                console.error('QRç¢¼ç”Ÿæˆå¤±æ•—:', error);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, 200, 200);
                ctx.fillStyle = '#374151';
                ctx.textAlign = 'center';
                ctx.fillText('QRç¢¼ç”Ÿæˆå¤±æ•—', 100, 100);
            }
            toggleModal(app.modals.parentLink, true);
        };

        const copyParentUrl = async () => {
            const urlInput = getEl('parent-url-display');
            try {
                await navigator.clipboard.writeText(urlInput.value);
                const btn = app.buttons.copyParentUrl;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²è¤‡è£½ï¼';
                btn.style.backgroundColor = '#10b981';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '';
                }, 2000);
                playSound(app.sounds.positive);
            } catch (err) {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
            }
        };

        // --- äº‹ä»¶ç›£è½å™¨è¨­å®š (åˆ†ç‚ºéœæ…‹èˆ‡å‹•æ…‹) ---

        const setupStaticEventListeners = () => {
            app.buttons.help.addEventListener('click', () => {
                playSound(app.sounds.click);
                toggleModal(app.modals.help, true);
            });
            app.buttons.closeHelp.addEventListener('click', () => toggleModal(app.modals.help, false));
            app.buttons.copyRulesCode.addEventListener('click', () => {
                const code = getEl('rules-code-block').innerText;
                navigator.clipboard.writeText(code).then(() => {
                    app.buttons.copyRulesCode.textContent = 'å·²è¤‡è£½ï¼';
                    setTimeout(() => { app.buttons.copyRulesCode.textContent = 'è¤‡è£½'; }, 2000);
                }).catch(err => alert('è¤‡è£½å¤±æ•—: ' + err));
            });

            app.buttons.closeManageStudent.addEventListener('click', () => toggleModal(app.modals.manageStudent, false));
            app.buttons.closeAvatars.addEventListener('click', () => toggleModal(app.modals.manageAvatars, false));
            app.buttons.cancelExport.addEventListener('click', () => toggleModal(app.modals.export, false));
            app.buttons.closePoints.addEventListener('click', () => toggleModal(app.modals.points, false));
            app.buttons.closeHistory.addEventListener('click', () => toggleModal(app.modals.history, false));
            app.buttons.cancelBehaviors.addEventListener('click', () => toggleModal(app.modals.manageBehaviors, false));
            app.buttons.addNewBehavior.addEventListener('click', () => addBehaviorEditorRow());
            app.buttons.closeParentLink.addEventListener('click', () => toggleModal(app.modals.parentLink, false));

            if (isTeacherMode) {
                app.buttons.teacherPanel.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    app.containers.controlPanel.classList.toggle('hidden');
                    app.containers.controlPanel.classList.toggle('flex');
                });
                app.buttons.parentLink.addEventListener('click', openParentLinkModal);
                app.buttons.copyParentUrl.addEventListener('click', copyParentUrl);
            } else {
                app.buttons.parentLink.style.display = 'none';
                app.buttons.teacherPanel.style.display = 'none';
                app.buttons.sort.style.display = 'none';
            }
        };

        const setupFirebaseEventListeners = () => {
            if (isTeacherMode) {
                app.buttons.manageStudent.addEventListener('click', openManageStudentModal);
                app.buttons.confirmAddStudent.addEventListener('click', handleAddStudents);
                app.buttons.manageAvatars.addEventListener('click', openAvatarsModal);
                app.buttons.exportGrades.addEventListener('click', () => { playSound(app.sounds.click); toggleModal(app.modals.export, true); });
                app.buttons.resetPoints.addEventListener('click', handleResetPoints);
                app.buttons.manageBehaviors.addEventListener('click', openManageBehaviorsModal);
                app.buttons.saveBehaviors.addEventListener('click', handleSaveBehaviors);
                app.inputs.avatarFile.addEventListener('change', handleAvatarUpload);
                app.buttons.exportOriginal.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    const originalOrderStudents = [...state.students].sort((a, b) => {
                        const groupA = a.group || 'ï¿¿'; const groupB = b.group || 'ï¿¿';
                        if (groupA === groupB) return a.name.localeCompare(b.name, 'zh-Hant');
                        return groupA.localeCompare(groupB, 'zh-Hant');
                    });
                    exportToCsv(originalOrderStudents, `${state.className}_æˆç¸¾(åˆ†çµ„å§“åé †åº).csv`);
                    toggleModal(app.modals.export, false);
                });
                app.buttons.exportSorted.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    const sortedStudents = [...state.students].sort((a, b) => b.points - a.points);
                    exportToCsv(sortedStudents, `${state.className}_æˆç¸¾(åˆ†æ•¸æ’åº).csv`);
                    toggleModal(app.modals.export, false);
                });
                app.buttons.viewHistory.addEventListener('click', () => { playSound(app.sounds.click); toggleModal(app.modals.points, false); openHistoryModal(); });
                app.containers.studentsTab.addEventListener('click', () => { playSound(app.sounds.click); switchTab('students'); });
                app.containers.groupsTab.addEventListener('click', () => { playSound(app.sounds.click); switchTab('groups'); });
                app.buttons.sort.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    const orders = ['byName', 'byPoints', 'byGroup'];
                    const currentOrderIndex = orders.indexOf(state.sortOrder);
                    state.sortOrder = orders[(currentOrderIndex + 1) % orders.length];
                    const icons = { byName: 'â˜…', byPoints: 'â†‘', byGroup: 'ğŸ“Š' };
                    const titles = { byName: 'æŒ‰å§“åæ’åº', byPoints: 'æŒ‰åˆ†æ•¸æ’åº', byGroup: 'æŒ‰åˆ†çµ„æ’åº' };
                    app.buttons.sort.textContent = icons[state.sortOrder];
                    app.buttons.sort.title = `ç›®å‰ï¼š${titles[state.sortOrder]}ï¼Œé»æ“Šåˆ‡æ›`;
                    renderStudentGrid();
                });
            }
        };

        // --- åˆå§‹åŒ–å‡½å¼ ---
        const init = async () => {
            setupFirebaseEventListeners();
            setLoading(true);
            try {
                const configDoc = await db.collection('config').doc('main').get();
                if (!configDoc.exists) {
                    await initializeFirstTimeData();
                }
                // è¨­å®šå³æ™‚ç›£è½å™¨
                state.unsubscribeListeners.forEach(unsub => unsub());
                state.unsubscribeListeners = [];

                const unsubConfig = db.collection('config').doc('main').onSnapshot(doc => {
                    const data = doc.data();
                    if(data) {
                        state.className = data.className || 'Classroom Points!';
                        app.titles.className.textContent = state.className;
                        document.title = state.className;
                    }
                });
                const unsubStudents = db.collection('students').onSnapshot(snapshot => {
                    state.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const hasGroups = state.students.some(s => s.group);
                    if (hasGroups) app.containers.tabsContainer.classList.remove('hidden');
                    else app.containers.tabsContainer.classList.add('hidden');
                    
                    renderStudentGrid();
                    if (!app.modals.manageStudent.classList.contains('hidden')) renderStudentDeletionList();
                    if (!app.modals.manageAvatars.classList.contains('hidden')) renderAvatarGrid();
                    if (state.activeTab === 'groups') renderGroupsGrid();
                    setLoading(false);
                }, error => { console.error("å­¸ç”Ÿè³‡æ–™ç›£è½å¤±æ•—:", error); setLoading(false); });

                const unsubBehaviors = db.collection('behaviors').onSnapshot(snapshot => {
                    state.behaviors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.behaviors.sort((a, b) => a.points - b.points);
                }, error => console.error("è¡Œç‚ºè³‡æ–™ç›£è½å¤±æ•—:", error));

                state.unsubscribeListeners.push(unsubConfig, unsubStudents, unsubBehaviors);
            } catch (error) {
                console.error("åˆå§‹åŒ–æˆ–è¼‰å…¥è³‡æ–™å¤±æ•—:", error);
                setLoading(false);
                app.containers.loadingText.textContent = "è¼‰å…¥è³‡æ–™å¤±æ•—ï¼";
                app.containers.setupPrompt.innerHTML = `<p class="mt-4 text-lg">è«‹æª¢æŸ¥æ‚¨çš„ Firebase è¨­å®šåŠç¶²è·¯é€£ç·šã€‚</p><p class="text-sm mt-2">éŒ¯èª¤è¨Šæ¯: ${error.message}</p>`;
                app.containers.setupPrompt.classList.remove('hidden');
                app.containers.spinner.classList.add('hidden');
            }
        };
        
        const initializeFirstTimeData = async () => {
            const batch = db.batch();
            batch.set(db.collection('config').doc('main'), { className: 'æˆ‘çš„ç­ç´š' });
            const defaultBehaviors = [
                { name: "ç©æ¥µåƒèˆ‡", points: 1, type: "positive" }, { name: "å¹«åŠ©åŒå­¸", points: 1, type: "positive" },
                { name: "æº–æ™‚äº¤ä½œæ¥­", points: 2, type: "positive" }, { name: "åœ˜éšŠåˆä½œ", points: 1, type: "positive" },
                { name: "å‰µæ„è¡¨ç¾", points: 2, type: "positive" }, { name: "ä¸Šèª²åˆ†å¿ƒ", points: -1, type: "negative" },
                { name: "æœªäº¤ä½œæ¥­", points: -2, type: "negative" }, { name: "å¹²æ“¾ç§©åº", points: -1, type: "negative" },
                { name: "é²åˆ°æ—©é€€", points: -1, type: "negative" }
            ];
            defaultBehaviors.forEach(b => batch.set(db.collection('behaviors').doc(), b));
            const sampleStudents = [
                { name: "ç‹å°æ˜", points: 0, avatar: generateAvatar("ç‹å°æ˜"), group: "ç¬¬ä¸€çµ„" },
                { name: "é™³å°è¯", points: 0, avatar: generateAvatar("é™³å°è¯"), group: "ç¬¬äºŒçµ„" }
            ];
            sampleStudents.forEach(s => batch.set(db.collection('students').doc(), s));
            await batch.commit();
        };

        // --- å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ ---
        setupStaticEventListeners();

        let db;
        try {
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.projectId) {
                throw new Error("Firebase config is not set.");
            }
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            init(); // <--- å¦‚æœæˆåŠŸï¼Œå‰‡å•Ÿå‹•å®Œæ•´æ‡‰ç”¨
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e.message);
            app.containers.initialPrompt.classList.remove('hidden');
            app.containers.loadingText.textContent = "å°šæœªè¨­å®š Firebaseï¼";
            app.containers.setupPrompt.innerHTML = `
                <p class="mt-4 text-lg">çœ‹èµ·ä¾†æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨æˆ–è¨­å®šä¸æ­£ç¢ºï¼</p>
                <p class="mt-2">è«‹é»æ“Šå³ä¸Šè§’ã€Œâ“ã€æŒ‰éˆ•ï¼Œä¾ç…§èªªæ˜è¨­å®šæ‚¨çš„ Firebase å°ˆæ¡ˆï¼Œç„¶å¾Œå°‡ <code>firebaseConfig</code> è²¼åˆ° HTML æª”æ¡ˆä¸­ã€‚</p>
            `;
            app.containers.spinner.classList.add('hidden');
        }
    });
    </script>
</body>
</html>