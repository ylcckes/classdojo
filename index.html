<!DOCTYPE html>
<html lang="zh-TW">
<!--
    æ™®æ™®é¢¨ç­ç´šæ¦®è­½é»æ•¸ç³»çµ± V5.2 (Firebaseç‰ˆ) -> ç¾ä»£æ¥µå…‰é¢¨æ ¼ V7.1 (æ¬Šé™å„ªåŒ–ç‰ˆ)
    ä½œè€…ï¼šé˜¿å‰›è€å¸«
    æ”¹é€ è€…ï¼šGemini
    
    æ›´æ–°æ—¥èªŒ V7.1:
    - [å®‰å…¨æ€§] Firebase è¨­å®šæŒ‰éˆ•æ”¹ç‚ºåƒ…åœ¨ã€Œæ•™å¸«æ¨¡å¼ã€ä¸‹é¡¯ç¤º (é¿å…èª¤è§¸)
    - [UI] èª¿æ•´æŒ‰éˆ•é †åºï¼šè¨­å®šæŒ‰éˆ•ç§»è‡³èªªæ˜æŒ‰éˆ•å·¦å´
    - [æ–‡ä»¶] æ–°å¢ã€Œå¸¸è¦‹éŒ¯èª¤æ’é™¤ã€èªªæ˜ï¼Œå¼•å°ä½¿ç”¨è€…å»ºç«‹ Firestore ç´¢å¼•
    
    æ›´æ–°æ—¥èªŒ V7.0:
    - å¯¦ä½œã€Œå¤šé‡è¨­å®šä¾†æºã€å„ªå…ˆç´šé‚è¼¯ (URL > Hardcoded > LocalStorage)
    - æ–°å¢ã€Œè¨­å®šé¢æ¿ã€ï¼šæ”¯æ´è²¼ä¸Š Config æ–‡å­—è‡ªå‹•è§£æ
    - æ–°å¢ã€Œä¸€éµåˆ†äº«ã€ï¼šç”ŸæˆåŒ…å«è¨­å®šåƒæ•¸çš„ QR Code èˆ‡é€£çµ
    - UI å„ªåŒ–ï¼šè¨­å®šå¼•å°ç•«é¢èˆ‡é‡è¨­åŠŸèƒ½
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šæ¦®è­½é»æ•¸ç³»çµ± (Modern V7)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸èˆ‡ä¸»é¡Œå®šç¾© --- */
        :root {
            /* æ·±è‰²ä¸»é¡Œ (Default/Dark) */
            --bg-color: #0f172a;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-panel-dark-bg: rgba(0, 0, 0, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --card-hover-shadow: 0 20px 40px -5px rgba(0,0,0,0.4), 0 0 20px rgba(139, 92, 246, 0.3);
            --bg-image: 
                radial-gradient(at 0% 0%, rgba(76, 29, 149, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(14, 165, 233, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.3) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(99, 102, 241, 0.3) 0px, transparent 50%);
            
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --secondary-gradient: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            --accent-gradient: linear-gradient(135deg, #f43f5e 0%, #f59e0b 100%);
        }

        /* äº®è‰²ä¸»é¡Œ (Light) */
        [data-theme="light"] {
            --bg-color: #f0f9ff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-panel-dark-bg: rgba(255, 255, 255, 0.85); /* äº®è‰²æ¨¡å¼ä¸‹è®Šç‚ºä¸é€æ˜ç™½ */
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --card-hover-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --bg-image: 
                radial-gradient(at 0% 0%, rgba(186, 230, 253, 0.5) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(254, 249, 195, 0.5) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(251, 207, 232, 0.5) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(221, 214, 254, 0.5) 0px, transparent 50%);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            background-image: var(--bg-image);
            background-attachment: fixed;
            background-size: cover;
            color: var(--text-main);
            min-height: 100vh;
            transition: color 0.3s ease, background 0.3s ease;
        }

        .font-exo {
            font-family: 'Exo 2', sans-serif;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .glass-panel-dark {
            background: var(--glass-panel-dark-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            color: var(--text-main);
        }

        /* Buttons */
        .modern-btn {
            background-size: 200% auto;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
            color: white !important; /* æŒ‰éˆ•æ–‡å­—æ°¸é ä¿æŒç™½è‰² */
        }
        .modern-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px rgba(0, 0, 0, 0.3);
            background-position: right center;
        }
        .modern-btn:active {
            transform: scale(0.98);
        }

        .btn-primary { background-image: var(--primary-gradient); }
        .btn-secondary { background-image: var(--secondary-gradient); }
        .btn-accent { background-image: var(--accent-gradient); }
        
        .btn-glass {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: var(--text-main);
        }
        [data-theme="light"] .btn-glass {
            background: rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .btn-glass:hover { background: rgba(255,255,255,0.25); }
        [data-theme="light"] .btn-glass:hover { background: rgba(0,0,0,0.1); }

        /* Student Card */
        .student-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .student-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--card-hover-shadow);
            border-color: rgba(139, 92, 246, 0.5);
        }
        .student-card img {
            transition: transform 0.5s ease;
        }
        .student-card:hover img {
            transform: scale(1.1);
        }

        /* Animations */
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 10px rgba(255,255,255,0.5), 0 0 20px rgba(255,255,255,0.3); }
            50% { text-shadow: 0 0 20px rgba(255,255,255,0.8), 0 0 40px rgba(167, 139, 250, 0.6); }
        }
        .title-glow {
            animation: glow 3s infinite;
        }
        [data-theme="light"] .title-glow {
            animation: none; /* äº®è‰²æ¨¡å¼ä¸‹å–æ¶ˆç™¼å…‰ï¼Œæ”¹ç‚ºæ·±è‰²é™°å½± */
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        .point-change-up {
            animation: point-up-modern 0.8s cubic-bezier(0, 0.9, 0.5, 1) forwards;
        }
        .point-change-down {
            animation: point-down-modern 0.8s cubic-bezier(0, 0.9, 0.5, 1) forwards;
        }

        @keyframes point-up-modern {
            0% { transform: translateY(0) scale(0.5); opacity: 0; filter: blur(10px); }
            20% { opacity: 1; transform: translateY(-20px) scale(1.2); filter: blur(0); text-shadow: 0 0 20px #4ade80; }
            100% { transform: translateY(-80px) scale(1.5); opacity: 0; filter: blur(5px); }
        }
        @keyframes point-down-modern {
            0% { transform: translateY(0) scale(0.5); opacity: 0; filter: blur(10px); }
            20% { opacity: 1; transform: translateY(20px) scale(1.2); filter: blur(0); text-shadow: 0 0 20px #f87171; }
            100% { transform: translateY(80px) scale(1.5); opacity: 0; filter: blur(5px); }
        }

        /* Modals */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }
        
        /* Tabs */
        .tab-button {
            position: relative;
            overflow: hidden;
            color: var(--text-muted);
        }
        .tab-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #a855f7);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .tab-button.active-tab::after {
            transform: scaleX(1);
        }
        .tab-button.active-tab {
            color: var(--text-main);
            background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
        }
        [data-theme="light"] .tab-button.active-tab {
            background: linear-gradient(to bottom, rgba(0,0,0,0.05), transparent);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05); 
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(150, 150, 150, 0.3); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(150, 150, 150, 0.5); 
        }

        /* Parent Mode */
        .parent-mode .student-card {
            pointer-events: none;
        }
        .parent-mode-banner {
            background: linear-gradient(90deg, #059669, #10b981);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
        }

        /* Prose Overrides for Themes */
        .prose { color: var(--text-muted); }
        .prose h4 { color: var(--text-main); border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem; }
        .prose a { color: #60a5fa; }
        [data-theme="light"] .prose a { color: #2563eb; }
        .prose strong { color: var(--text-main); }
        .prose pre { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
        [data-theme="light"] .prose pre { background: #f1f5f9; border: 1px solid #cbd5e1; }
        .prose code { color: #f472b6; }
        [data-theme="light"] .prose code { color: #db2777; }
        
        /* Utility overrides for light mode */
        [data-theme="light"] .text-white { color: #1e293b; } /* åè½‰å¼·åˆ¶ç™½è‰²çš„æ–‡å­— */
        [data-theme="light"] .text-gray-400 { color: #64748b; }
        [data-theme="light"] .text-gray-200 { color: #1e293b; }
        [data-theme="light"] .text-blue-300 { color: #3b82f6; }
        [data-theme="light"] .border-white\/20 { border-color: rgba(0,0,0,0.1); }
        [data-theme="light"] .border-white\/10 { border-color: rgba(0,0,0,0.05); }
        [data-theme="light"] .bg-white\/5 { background-color: rgba(255,255,255,0.5); }
        [data-theme="light"] .bg-white\/10 { background-color: rgba(0,0,0,0.05); }
        [data-theme="light"] .bg-black\/20 { background-color: rgba(255,255,255,0.5); }
        [data-theme="light"] .bg-black\/30 { background-color: rgba(255,255,255,0.8); }
        [data-theme="light"] .bg-white { background-color: #ffffff; }
        
        /* Icons */
        .icon { width: 1.5rem; height: 1.5rem; }
    </style>
</head>
<body class="antialiased selection:bg-purple-500 selection:text-white">

    <!-- ä¸»å®¹å™¨ -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- é ‚éƒ¨æ¨™é¡Œå’Œæ§åˆ¶æŒ‰éˆ• -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <div class="flex flex-col items-center md:items-start">
                <h1 id="class-name-title" class="font-exo font-black text-5xl md:text-7xl text-transparent bg-clip-text bg-gradient-to-r from-teal-300 via-blue-400 to-purple-400 title-glow drop-shadow-lg pb-2">Classroom Points!</h1>
                <span class="font-light text-gray-400 text-sm tracking-widest uppercase">(Remixed by Gemini â€¢ Original by é˜¿å‰›è€å¸«)</span>
            </div>
            <div class="flex items-center space-x-3 bg-white/5 p-2 rounded-full backdrop-blur-md border border-white/10 shadow-lg">
                <button id="theme-toggle-btn" class="w-12 h-12 rounded-full flex items-center justify-center hover:bg-white/10 transition-colors text-yellow-300" title="åˆ‡æ›ä¸»é¡Œ">
                    <!-- Sun/Moon Icon -->
                    <svg id="icon-sun" class="w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                    </svg>
                    <svg id="icon-moon" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                    </svg>
                </button>
                <div class="w-px h-6 bg-white/20 mx-1"></div>
                
                <button id="sort-btn" class="w-12 h-12 rounded-full flex items-center justify-center hover:bg-white/10 transition-colors text-yellow-400" title="åˆ‡æ›æ’åº">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                      <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button id="parent-link-btn" class="w-12 h-12 rounded-full flex items-center justify-center hover:bg-white/10 transition-colors text-green-400" title="å®¶é•·é€£çµ">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                      <path fill-rule="evenodd" d="M3 4.875C3 3.839 3.84 3 4.875 3h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013 9.375v-4.5zM4.875 4.5a.375.375 0 00-.375.375v4.5c0 .207.168.375.375.375h4.5a.375.375 0 00.375-.375v-4.5a.375.375 0 00-.375-.375h-4.5zm7.875.375c0-1.036.84-1.875 1.875-1.875h4.5C20.16 3 21 3.84 21 4.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5a1.875 1.875 0 01-1.875-1.875v-4.5zm1.875-.375a.375.375 0 00-.375.375v4.5c0 .207.168.375.375.375h4.5a.375.375 0 00.375-.375v-4.5a.375.375 0 00-.375-.375h-4.5zM6 15.375c0-1.035.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 016 19.875v-4.5zm1.875-.375a.375.375 0 00-.375.375v4.5c0 .207.168.375.375.375h4.5a.375.375 0 00.375-.375v-4.5a.375.375 0 00-.375-.375h-4.5z" clip-rule="evenodd" />
                      <path d="M16.5 15.75a.75.75 0 00-.75.75v1.5h-1.5a.75.75 0 000 1.5h1.5v1.5a.75.75 0 001.5 0v-1.5h1.5a.75.75 0 000-1.5h-1.5v-1.5a.75.75 0 00-.75-.75z" />
                    </svg>
                </button>
                <button id="teacher-panel-btn" class="w-12 h-12 rounded-full flex items-center justify-center hover:bg-white/10 transition-colors text-blue-400" title="æ•™å¸«é¢æ¿">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                      <path d="M18.75 12.75h1.5a.75.75 0 000-1.5h-1.5a.75.75 0 000 1.5zM12 6a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5A.75.75 0 0112 6zM12 18a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5A.75.75 0 0112 18zM3.75 6.75h1.5a.75.75 0 100-1.5h-1.5a.75.75 0 000 1.5zM5.25 18.75h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 010 1.5zM3 12a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5A.75.75 0 013 12zM9 3.75a2.25 2.25 0 100 4.5 2.25 2.25 0 000-4.5zM12.75 12a2.25 2.25 0 114.5 0 2.25 2.25 0 01-4.5 0zM9 15.75a2.25 2.25 0 100 4.5 2.25 2.25 0 000-4.5z" />
                    </svg>
                </button>
                
                <!-- æ–°å¢ï¼šè¨­å®šæŒ‰éˆ• (å·²ç§»è‡³èªªæ˜æŒ‰éˆ•å·¦å´) -->
                <button id="config-btn" class="w-12 h-12 rounded-full flex items-center justify-center hover:bg-white/10 transition-colors text-gray-300" title="Firebase è¨­å®š">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>

                <button id="help-btn" class="w-12 h-12 rounded-full flex items-center justify-center hover:bg-white/10 transition-colors text-pink-400" title="èªªæ˜">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                      <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm11.378-3.917c-.89-.777-2.366-.777-3.255 0a.75.75 0 01-.988-1.129c1.454-1.272 3.776-1.272 5.23 0 1.513 1.324 1.513 3.518 0 4.842a3.75 3.75 0 01-.837.552c-.676.328-1.028.774-1.028 1.152v.202a.75.75 0 01-1.5 0v-.202c0-.944.606-1.657 1.336-2.008a2.25 2.25 0 00.512-.331c.94-.822.94-2.153 0-2.976zM12 17.062a.938.938 0 110-1.875.938.938 0 010 1.875z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- æ•™å¸«ç®¡ç†é¢æ¿ (é è¨­éš±è—) -->
        <div id="control-panel" class="glass-panel p-6 rounded-2xl mb-10 flex flex-wrap gap-4 justify-center hidden animate-fade-in-down">
            <button id="manage-student-btn" class="modern-btn btn-secondary rounded-xl px-6 py-3 font-bold text-lg shadow-lg">ç®¡ç†å­¸ç”Ÿ</button>
            <button id="manage-avatars-btn" class="modern-btn btn-secondary rounded-xl px-6 py-3 font-bold text-lg shadow-lg" style="background-image: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);">ä¸Šå‚³é ­åƒ</button>
            <button id="manage-behaviors-btn" class="modern-btn btn-secondary rounded-xl px-6 py-3 font-bold text-lg shadow-lg" style="background-image: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);">ç®¡ç†è¡Œç‚º</button>
            <button id="class-settings-btn" class="modern-btn btn-secondary rounded-xl px-6 py-3 font-bold text-lg shadow-lg" style="background-image: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);">ç­ç´šè¨­å®š</button>
            <button id="export-grades-btn" class="modern-btn btn-primary rounded-xl px-6 py-3 font-bold text-lg shadow-lg">åŒ¯å‡ºæˆç¸¾</button>
            <button id="reset-points-btn" class="modern-btn btn-accent rounded-xl px-6 py-3 font-bold text-lg shadow-lg">é‡è¨­é»æ•¸</button>
        </div>

        <!-- åˆ†é å°èˆª -->
        <div id="tabs-container" class="mb-8 hidden">
            <div class="flex border-b border-white/20">
                <button id="students-tab" class="tab-button active-tab px-8 py-3 font-bold text-lg rounded-t-xl mr-2 transition-colors">å­¸ç”Ÿ</button>
                <button id="groups-tab" class="tab-button px-8 py-3 font-bold text-lg rounded-t-xl transition-colors">åˆ†çµ„</button>
            </div>
        </div>

        <!-- å­¸ç”Ÿæª¢è¦– -->
        <div id="students-view" class="tab-content min-h-[300px]">
            <div id="student-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <!-- å­¸ç”Ÿå¡ç‰‡å°‡æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
        </div>

        <!-- åˆ†çµ„æª¢è¦– -->
        <div id="groups-view" class="tab-content hidden min-h-[300px]">
            <div id="groups-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- åˆ†çµ„å¡ç‰‡å°‡æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
        </div>

        <!-- åˆå§‹æç¤º/è¼‰å…¥ç•«é¢ -->
        <div id="initial-prompt" class="text-center py-32 glass-panel rounded-3xl mx-auto max-w-2xl mt-10">
            <p id="loading-text" class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">æ­£åœ¨é€£æ¥è³‡æ–™åº«...</p>
            <div id="spinner" class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto mt-8 shadow-[0_0_20px_rgba(59,130,246,0.5)]"></div>
            
            <!-- Setup Prompt (ç•¶æ²’æœ‰ Config æ™‚é¡¯ç¤º) -->
            <div id="setup-prompt" class="hidden mt-6 text-lg text-gray-300 px-8 leading-relaxed">
                <p class="mb-6 font-bold text-red-300 text-xl">âš ï¸ å°šæœªè¨­å®šè³‡æ–™åº«é€£ç·š</p>
                <p class="mb-8 text-sm text-gray-400">è«‹é¸æ“‡ä»¥ä¸‹æ–¹å¼é–‹å§‹ä½¿ç”¨ç³»çµ±</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="init-help-btn" class="modern-btn btn-secondary rounded-xl px-6 py-3 font-bold flex items-center justify-center gap-2">
                        <span>ğŸ“– ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿçœ‹èªªæ˜</span>
                    </button>
                    <button id="init-config-btn" class="modern-btn btn-primary rounded-xl px-6 py-3 font-bold flex items-center justify-center gap-2">
                        <span>âš™ï¸ è¨­å®š Firebase</span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- æ‰€æœ‰å½ˆå‡ºè¦–çª— (Modals) -->

    <!-- [æ–°] è¨­å®š Firebase Modal -->
    <div id="config-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="glass-panel-dark w-full max-w-2xl p-8 rounded-2xl shadow-2xl flex flex-col" style="max-height: 90vh;">
            <h2 class="font-exo text-3xl mb-2 text-white border-b border-white/20 pb-4">Firebase è¨­å®š</h2>
            
            <div class="overflow-y-auto custom-scrollbar flex-grow pr-2">
                <!-- 1. è¼¸å…¥å€ -->
                <div class="mb-6">
                    <label class="block text-blue-300 text-sm font-bold mb-2">
                        è²¼ä¸Š Firebase è¨­å®šç‰©ä»¶
                        <span class="text-gray-400 font-normal text-xs ml-2">(è«‹è¤‡è£½ apiKey åˆ° appId ä¹‹é–“çš„ 6 è¡Œå…§å®¹)</span>
                    </label>
                    <textarea id="config-textarea" class="w-full h-40 p-4 bg-black/30 border border-white/20 rounded-lg text-green-400 font-mono text-sm focus:outline-none focus:border-blue-500 transition-colors" placeholder='apiKey: "AIza...",
authDomain: "...",
projectId: "...",
storageBucket: "...",
messagingSenderId: "...",
appId: "..."'></textarea>
                </div>

                <div class="flex justify-between items-center mb-8">
                    <button id="reset-config-btn" class="text-red-400 hover:text-red-300 text-sm font-bold border border-red-500/30 hover:bg-red-500/10 px-4 py-2 rounded-lg transition-colors">
                        ğŸ—‘ï¸ æ¸…é™¤æœ¬æ©Ÿè¨­å®š
                    </button>
                    <div class="space-x-3">
                        <button id="close-config-btn" class="btn-glass rounded-lg px-6 py-2 font-bold">å–æ¶ˆ</button>
                        <button id="save-config-btn" class="modern-btn btn-primary rounded-lg px-6 py-2 font-bold">å„²å­˜ä¸¦é€£ç·š</button>
                    </div>
                </div>

                <!-- 2. åˆ†äº«å€ -->
                <div id="share-config-section" class="bg-white/5 rounded-xl p-6 border border-white/10 hidden">
                    <h3 class="font-bold text-lg text-yellow-300 mb-4 flex items-center">
                        ğŸ”— åˆ†äº«æ­¤è¨­å®šçµ¦å…¶ä»–è£ç½®
                    </h3>
                    <div class="flex flex-col md:flex-row gap-6 items-center">
                        <div class="bg-white p-2 rounded-lg">
                            <canvas id="config-qr-canvas"></canvas>
                        </div>
                        <div class="flex-grow w-full">
                            <p class="text-sm text-gray-300 mb-2">æƒæ QR Code æˆ–è¤‡è£½é€£çµï¼Œå³å¯åœ¨æ‰‹æ©Ÿæˆ–å…¶ä»–é›»è…¦ä¸Šç›´æ¥è¼‰å…¥æ­¤è¨­å®šã€‚</p>
                            <div class="bg-black/30 p-2 rounded border border-white/10 mb-2 flex items-center">
                                <input type="text" id="config-share-url" class="w-full bg-transparent border-none outline-none text-gray-400 text-xs font-mono" readonly>
                            </div>
                            <button id="copy-config-link-btn" class="w-full modern-btn btn-secondary rounded-lg px-4 py-2 font-bold text-sm">
                                ğŸ“‹ è¤‡è£½å¿«é€Ÿè¨­å®šé€£çµ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- èªªæ˜ Modal -->
    <div id="help-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="glass-panel-dark w-full max-w-3xl p-8 rounded-2xl flex flex-col shadow-2xl" style="height: 85vh;">
            <h2 class="font-exo text-3xl mb-6 text-white border-b border-white/20 pb-4">å¦‚ä½•å–å¾—è¨­å®š</h2>
            <div class="prose max-w-none overflow-y-auto flex-grow pr-4 custom-scrollbar">
                <h4>æ­¥é©Ÿ 1ï¼šå»ºç«‹ Firebase å°ˆæ¡ˆ</h4>
                <ol>
                    <li>å‰å¾€ <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-400 hover:text-blue-300">Firebase æ§åˆ¶å°</a>ã€‚</li>
                    <li>é»æ“Šã€Œå»ºç«‹å°ˆæ¡ˆã€ï¼Œä¸¦ç‚ºæ‚¨çš„å°ˆæ¡ˆå‘½åã€‚</li>
                </ol>

                <h4>æ­¥é©Ÿ 2ï¼šå»ºç«‹ Firestore è³‡æ–™åº«</h4>
                <ol>
                    <li>åœ¨å·¦å´é¸å–®é»æ“Šã€Œå»ºæ§‹ã€ > ã€ŒFirestore Databaseã€ã€‚</li>
                    <li>é»æ“Šã€Œå»ºç«‹è³‡æ–™åº«ã€ï¼Œé¸æ“‡ã€Œä»¥<strong>æ¸¬è©¦æ¨¡å¼</strong>å•Ÿå‹•ã€ã€‚</li>
                    <li>é¸æ“‡ä½ç½®å¾Œå•Ÿç”¨ã€‚</li>
                </ol>

                <h4>æ­¥é©Ÿ 3ï¼šå–å¾—è¨­å®šç¢¼</h4>
                <ol>
                    <li>é»æ“Šã€Œå°ˆæ¡ˆç¸½è¦½ã€æ—çš„é½’è¼ª âš™ï¸ > ã€Œå°ˆæ¡ˆè¨­å®šã€ã€‚</li>
                    <li>åœ¨ä¸‹æ–¹ã€Œæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ã€å€å¡Šï¼Œé»æ“Š <strong>&lt;/&gt;</strong> (Web) åœ–ç¤ºã€‚</li>
                    <li>è¨»å†Šæš±ç¨±å¾Œï¼Œæ‚¨æœƒçœ‹åˆ°ä¸€æ®µç¨‹å¼ç¢¼ã€‚</li>
                    <li><strong>è¤‡è£½ `const firebaseConfig = { ... };` å¤§æ‹¬è™Ÿä¸­é–“çš„ 6 è¡Œå…§å®¹ã€‚</strong></li>
                    <li>å›åˆ°æœ¬ç³»çµ±ï¼Œé»æ“Šå³ä¸Šè§’çš„è¨­å®š (âš™ï¸) æŒ‰éˆ•ï¼Œè²¼ä¸Šä¸¦å„²å­˜ã€‚</li>
                </ol>
                
                <h4 style="color: #f87171;">æ­¥é©Ÿ 4ï¼šè¨­å®šæ¬Šé™ (é‡è¦ï¼)</h4>
                <div class="relative bg-black/50 text-gray-300 p-4 rounded-lg my-4 border border-white/10">
                    <button id="copy-rules-code-btn" class="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded text-xs transition-colors">è¤‡è£½è¦å‰‡</button>
                    <pre><code id="rules-code-block" class="text-sm font-mono text-green-400">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</code></pre>
                </div>
                <p>è«‹å°‡ä¸Šè¿°è¦å‰‡è²¼åˆ° Firestore çš„ã€Œè¦å‰‡ã€åˆ†é ä¸­ä¸¦ç™¼ä½ˆã€‚</p>

                <!-- æ–°å¢ï¼šå¸¸è¦‹éŒ¯èª¤æ’é™¤ -->
                <h4 style="margin-top: 2rem; color: #fbbf24;">é™„éŒ„ï¼šå¸¸è¦‹éŒ¯èª¤æ’é™¤</h4>
                <p><strong>å•é¡Œï¼š</strong>é»æ“Šã€ŒæŸ¥çœ‹ç´€éŒ„ã€æ™‚æ²’æœ‰åæ‡‰æˆ–è·³å‡ºéŒ¯èª¤ã€‚</p>
                <p><strong>åŸå› ï¼š</strong>é€™æ˜¯ç¬¬ä¸€æ¬¡æŸ¥è©¢æ­·å²ç´€éŒ„æ™‚æœƒç™¼ç”Ÿçš„æ­£å¸¸æƒ…æ³ã€‚Firebase éœ€è¦ç‚ºã€Œå­¸ç”ŸIDã€å’Œã€Œæ™‚é–“æˆ³ã€çš„çµ„åˆæŸ¥è©¢å»ºç«‹ä¸€å€‹ç´¢å¼•ï¼ˆå°±åƒæ›¸æœ¬çš„ç›®éŒ„ï¼‰ï¼Œæ‰èƒ½å¿«é€Ÿåœ°æ’åºèˆ‡å°‹æ‰¾è³‡æ–™ã€‚</p>
                <p><strong>è§£æ±ºæ–¹æ³•ï¼š</strong></p>
                <ol>
                    <li>åœ¨ç€è¦½å™¨ä¸­æŒ‰ä¸‹ <code>F12</code> éµæ‰“é–‹ã€Œé–‹ç™¼äººå“¡å·¥å…·ã€ï¼Œä¸¦åˆ‡æ›åˆ°ã€ŒConsole (ä¸»æ§å°)ã€åˆ†é ã€‚</li>
                    <li>æ‚¨æ‡‰è©²æœƒçœ‹åˆ°ä¸€æ¢ä¾†è‡ª Firebase çš„éŒ¯èª¤è¨Šæ¯ï¼Œå…§å®¹åŒ…å« "The query requires an index"ã€‚</li>
                    <li>é€™æ¢éŒ¯èª¤è¨Šæ¯ä¸­æœƒåŒ…å«ä¸€å€‹å¯é»æ“Šçš„é€£çµï¼Œçœ‹èµ·ä¾†åƒé€™æ¨£ï¼š<code>https://console.firebase.google.com/v1/r/project/...</code></li>
                    <li>é»æ“Šé‚£å€‹é€£çµã€‚å®ƒæœƒç›´æ¥å¸¶æ‚¨å‰å¾€ Firebase ç¶²ç«™çš„ç´¢å¼•å»ºç«‹é é¢ï¼Œä¸¦ä¸”æ‰€æœ‰éœ€è¦çš„è¨­å®šéƒ½å·²è‡ªå‹•å¡«å¥½ã€‚</li>
                    <li>åœ¨ Firebase é é¢ä¸­ï¼Œç›´æ¥é»æ“Šã€Œå»ºç«‹ç´¢å¼•ã€æŒ‰éˆ•ã€‚</li>
                    <li>ç´¢å¼•å»ºç«‹éœ€è¦å¹¾åˆ†é˜çš„æ™‚é–“ã€‚æ‚¨å¯ä»¥åœ¨ Firebase ç¶²ç«™ä¸Šçœ‹åˆ°å»ºç«‹é€²åº¦ã€‚</li>
                    <li>ç´¢å¼•å»ºç«‹å®Œæˆå¾Œï¼Œå›åˆ°æœ¬é é¢é‡æ–°æ•´ç†ï¼Œã€ŒæŸ¥çœ‹ç´€éŒ„ã€åŠŸèƒ½ç¾åœ¨æ‡‰è©²å°±å¯ä»¥æ­£å¸¸é‹ä½œäº†ã€‚</li>
                </ol>
            </div>
            <div class="mt-6 text-right pt-4 border-t border-white/10">
                <button id="close-help-btn" class="modern-btn btn-primary rounded-lg px-8 py-2 font-bold">æˆ‘æ‡‚äº†ï¼</button>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å­¸ç”Ÿ Modal -->
    <div id="manage-student-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="glass-panel-dark w-full max-w-md p-6 rounded-2xl flex flex-col shadow-2xl" style="height: 80vh;">
            <h2 class="font-exo text-2xl mb-4 text-white">ç®¡ç†å­¸ç”Ÿ</h2>
            
            <div class="mb-4 pb-4 border-b border-white/20">
                <h3 class="font-bold text-lg mb-2 text-blue-300">æ–°å¢å­¸ç”Ÿ</h3>
                <p class="mb-2 text-xs text-gray-400">æ ¼å¼ï¼šå§“å æˆ– å§“å,åˆ†çµ„ (æ¯è¡Œä¸€ä½)</p>
                <textarea id="student-name-input" class="w-full h-24 p-3 bg-black/30 border border-white/20 rounded-lg mb-3 text-white placeholder-gray-600 focus:outline-none focus:border-blue-500 transition-colors" placeholder="ç‹å°æ˜
é™³å¤§è¯,ç¬¬ä¸€çµ„
æ—ç¾éº—,ç¬¬äºŒçµ„"></textarea>
                <button id="confirm-add-student-btn" class="w-full modern-btn btn-primary rounded-lg px-4 py-2 font-bold text-sm">ç¢ºèªæ–°å¢</button>
            </div>

            <div class="flex-grow overflow-y-auto">
                 <h3 class="font-bold text-lg mb-2 text-red-300">å­¸ç”Ÿåˆ—è¡¨</h3>
                 <div id="delete-student-list" class="space-y-2 pr-2">
                    <!-- å­¸ç”Ÿåˆ—è¡¨ -->
                 </div>
            </div>

            <div class="mt-4 text-right">
                <button id="close-manage-student-btn" class="btn-glass rounded-lg px-6 py-2 font-bold text-sm transition-colors">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- ç­ç´šè¨­å®š Modal -->
    <div id="class-settings-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="glass-panel-dark w-full max-w-sm p-8 rounded-2xl shadow-2xl">
            <h2 class="font-exo text-2xl mb-6 text-white text-center">ç­ç´šè¨­å®š</h2>
            <div class="mb-6">
                <label class="block text-blue-300 text-sm font-bold mb-2">ç­ç´šåç¨± (é¡¯ç¤ºæ–¼æ¨™é¡Œ)</label>
                <input type="text" id="class-name-input" class="w-full p-3 bg-black/30 border border-white/20 rounded-lg text-white placeholder-gray-600 focus:outline-none focus:border-purple-500 transition-colors text-center font-bold text-lg">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="close-class-settings-btn" class="btn-glass rounded-lg px-6 py-2 font-bold">å–æ¶ˆ</button>
                <button id="save-class-settings-btn" class="modern-btn btn-primary rounded-lg px-6 py-2 font-bold">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- åŒ¯å‡ºæˆç¸¾ Modal -->
    <div id="export-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="glass-panel-dark w-full max-w-sm p-8 rounded-2xl shadow-2xl text-center">
            <h2 class="font-exo text-3xl mb-6 text-white">åŒ¯å‡ºæˆç¸¾</h2>
            <div class="flex flex-col space-y-4">
                <button id="export-original-btn" class="modern-btn btn-secondary rounded-xl px-6 py-4 font-bold shadow-lg">æŒ‰åˆ†çµ„å§“åé †åº</button>
                <button id="export-sorted-btn" class="modern-btn btn-primary rounded-xl px-6 py-4 font-bold shadow-lg">æŒ‰å¾—åˆ†é«˜ä½</button>
                <button id="export-logs-btn" class="modern-btn btn-accent rounded-xl px-6 py-4 font-bold shadow-lg">åŒ¯å‡ºå®Œæ•´æ­·å²ç´€éŒ„ (CSV)</button>
            </div>
            <div class="mt-8">
                <button id="cancel-export-btn" class="btn-glass rounded-lg px-6 py-2 font-bold">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- åŠ æ¸›åˆ† Modal -->
    <div id="points-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="glass-panel-dark w-full max-w-2xl p-6 rounded-2xl shadow-2xl border border-white/20">
            <h2 id="points-modal-title" class="font-exo text-3xl mb-6 text-center text-white font-bold tracking-wide">çµ¦äºˆé»æ•¸</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- åŠ åˆ†é …ç›® -->
                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                    <h3 class="font-bold text-xl text-green-400 mb-3 flex items-center"><span class="text-2xl mr-2">ğŸ‘</span> åŠ åˆ†é …ç›®</h3>
                    <div id="positive-behaviors" class="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>
                <!-- æ‰£åˆ†é …ç›® -->
                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                    <h3 class="font-bold text-xl text-red-400 mb-3 flex items-center"><span class="text-2xl mr-2">âš ï¸</span> å¾…æ”¹é€²</h3>
                    <div id="negative-behaviors" class="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>
            </div>
            <div class="mt-8 flex justify-center space-x-4">
                 <button id="view-history-btn" class="modern-btn btn-glass text-yellow-300 border-yellow-300/30 hover:bg-yellow-300/10 rounded-lg px-6 py-2 font-bold">æŸ¥çœ‹ç´€éŒ„</button>
                 <button id="close-points-modal-btn" class="modern-btn btn-glass rounded-lg px-6 py-2 font-bold">é—œé–‰è¦–çª—</button>
            </div>
        </div>
    </div>

    <!-- æ­·å²ç´€éŒ„ Modal -->
    <div id="history-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="glass-panel-dark w-full max-w-md p-6 rounded-2xl flex flex-col shadow-2xl" style="height: 70vh;">
            <h2 id="history-modal-title" class="font-exo text-2xl mb-4 text-white">æ­·å²ç´€éŒ„</h2>
            <div id="history-list" class="flex-grow overflow-y-auto bg-black/20 p-4 rounded-xl border border-white/10 custom-scrollbar">
                <!-- ç´€éŒ„å°‡æ’å…¥æ­¤è™• -->
            </div>
            <div class="mt-4 text-right">
                <button id="close-history-modal-btn" class="modern-btn btn-primary rounded-lg px-6 py-2 font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- ç®¡ç†è¡Œç‚º Modal -->
    <div id="manage-behaviors-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="glass-panel-dark w-full max-w-2xl p-6 rounded-2xl flex flex-col shadow-2xl" style="height: 80vh;">
            <h2 class="font-exo text-2xl mb-4 text-white">ç®¡ç†è¡Œç‚ºé …ç›®</h2>
            <div class="flex-grow overflow-y-auto space-y-3 p-2" id="behavior-list-editor">
                <!-- è¡Œç‚ºç·¨è¼¯å™¨ -->
            </div>
            <div class="mt-4 pt-4 border-t border-white/20 flex justify-between items-center">
                <button id="add-new-behavior-btn" class="modern-btn btn-glass text-green-400 border-green-400/30 hover:bg-green-400/10 rounded-lg px-4 py-2 font-bold">+ æ–°å¢ä¸€é …</button>
                <div class="space-x-2">
                    <button id="cancel-behaviors-btn" class="btn-glass rounded-lg px-4 py-2 font-bold">å–æ¶ˆ</button>
                    <button id="save-behaviors-btn" class="modern-btn btn-primary rounded-lg px-6 py-2 font-bold">å„²å­˜è®Šæ›´</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å®¶é•·æ¨¡å¼é€£çµ Modal -->
    <div id="parent-link-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="glass-panel-dark w-full max-w-md p-8 rounded-2xl shadow-2xl text-center">
            <h2 class="font-exo text-2xl mb-4 text-white">å®¶é•·æª¢è¦–é€£çµ</h2>
            <div class="flex justify-center mb-6 bg-white p-4 rounded-xl w-max mx-auto">
                <canvas id="qr-canvas"></canvas>
            </div>
            <div class="bg-black/30 border border-white/20 rounded-lg p-3 mb-4 flex items-center">
                <input type="text" id="parent-url-display" class="w-full text-sm text-center bg-transparent border-none outline-none text-blue-300 font-mono" readonly>
            </div>
            <button id="copy-parent-url-btn" class="w-full modern-btn btn-primary rounded-xl px-6 py-3 font-bold mb-3 shadow-lg">ğŸ“‹ è¤‡è£½é€£çµ</button>
            <p class="text-xs text-gray-400">å®¶é•·ä½¿ç”¨æ­¤é€£çµåƒ…èƒ½æª¢è¦–é»æ•¸</p>
            <div class="mt-4">
                <button id="close-parent-link-btn" class="text-gray-400 hover:text-white text-sm underline">é—œé–‰è¦–çª—</button>
            </div>
        </div>
    </div>
    
    <!-- é ­åƒç®¡ç† Modal -->
    <div id="manage-avatars-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden z-50">
        <div class="glass-panel-dark w-full max-w-4xl p-6 rounded-2xl flex flex-col shadow-2xl" style="height: 80vh;">
            <h2 class="font-exo text-2xl mb-2 text-white">å­¸ç”Ÿé ­åƒç®¡ç†</h2>
            <p class="text-sm mb-6 text-gray-400">é»æ“Šå­¸ç”Ÿé ­åƒä¸Šå‚³æ–°åœ–ç‰‡ (è‡ªå‹•å£“ç¸®)</p>
            
            <div class="flex-grow overflow-y-auto custom-scrollbar">
                <div id="avatar-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- å­¸ç”Ÿé ­åƒå¡ç‰‡ -->
                </div>
            </div>
            
            <input type="file" id="avatar-file-input" accept="image/*" class="hidden">
            
            <div class="mt-6 text-right">
                <button id="close-avatars-btn" class="btn-glass rounded-lg px-8 py-2 font-bold">å®Œæˆ</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- æ ¸å¿ƒé‚è¼¯ï¼šè¨­å®šç®¡ç† (Config Management) ---

        // 1. Hardcoded Default (å„ªå…ˆç´š 2)
        // âœ¨âœ¨âœ¨ ä½¿ç”¨è€…è«‹ç›´æ¥ä¿®æ”¹ä¸‹æ–¹å¼•è™Ÿå…§çš„æ•¸å€¼ï¼Œå¡«å…¥æ‚¨çœŸå¯¦çš„ Firebase è¨­å®šå³å¯ (ç„¡éœ€æ›´å‹•è®Šæ•¸åç¨±æˆ–å¤§æ‹¬è™Ÿ) âœ¨âœ¨âœ¨
        const hardcodedConfig = {
  apiKey: "AIzaSyCyW3P6Xekwf_DLndgZt4o21sVMla_5BJw",
  authDomain: "ckesclassdojo.firebaseapp.com",
  projectId: "ckesclassdojo",
  storageBucket: "ckesclassdojo.firebasestorage.app",
  messagingSenderId: "613646301956",
  appId: "1:613646301956:web:6b1a37196ce3b591e8ee51"
        };
        // âœ¨âœ¨âœ¨ END OF ç¡¬ç·¨ç¢¼è¨­å®š âœ¨âœ¨âœ¨

        // Config è™•ç†å‡½å¼
        const getConfig = () => {
            // Priority 1: URL Parameter
            const urlParams = new URLSearchParams(window.location.search);
            const encodedConfig = urlParams.get('config');
            if (encodedConfig) {
                try {
                    const decoded = JSON.parse(atob(encodedConfig));
                    if (decoded.apiKey && decoded.projectId) {
                        localStorage.setItem('firebaseConfig', JSON.stringify(decoded));
                        // æ¸…é™¤ URL åƒæ•¸ä¸¦é‡æ–°æ•´ç†
                        urlParams.delete('config');
                        const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                        window.history.replaceState({}, '', newUrl);
                        return decoded;
                    }
                } catch (e) {
                    console.error('URL Config è§£æå¤±æ•—', e);
                }
            }

            // Priority 2: Hardcoded
            if (hardcodedConfig.apiKey !== "demo" && hardcodedConfig.projectId !== "demo") {
                return hardcodedConfig;
            }

            // Priority 3: LocalStorage
            const localConfig = localStorage.getItem('firebaseConfig');
            if (localConfig) {
                try {
                    return JSON.parse(localConfig);
                } catch (e) {
                    console.error('LocalStorage Config è§£æå¤±æ•—');
                }
            }

            return null; // No valid config found
        };

        const activeConfig = getConfig();

        // --- å…ƒç´ é¸æ“‡ ---
        const getEl = (id) => document.getElementById(id);
        const app = {
            modals: {
                help: getEl('help-modal'),
                manageStudent: getEl('manage-student-modal'),
                manageAvatars: getEl('manage-avatars-modal'),
                export: getEl('export-modal'),
                points: getEl('points-modal'),
                history: getEl('history-modal'),
                manageBehaviors: getEl('manage-behaviors-modal'),
                parentLink: getEl('parent-link-modal'),
                classSettings: getEl('class-settings-modal'),
                config: getEl('config-modal'), // æ–°å¢
            },
            buttons: {
                themeToggle: getEl('theme-toggle-btn'),
                sort: getEl('sort-btn'),
                teacherPanel: getEl('teacher-panel-btn'),
                parentLink: getEl('parent-link-btn'),
                help: getEl('help-btn'),
                closeHelp: getEl('close-help-btn'),
                manageStudent: getEl('manage-student-btn'),
                closeManageStudent: getEl('close-manage-student-btn'),
                confirmAddStudent: getEl('confirm-add-student-btn'),
                manageAvatars: getEl('manage-avatars-btn'),
                closeAvatars: getEl('close-avatars-btn'),
                exportGrades: getEl('export-grades-btn'),
                exportOriginal: getEl('export-original-btn'),
                exportSorted: getEl('export-sorted-btn'),
                exportLogs: getEl('export-logs-btn'),
                cancelExport: getEl('cancel-export-btn'),
                closePoints: getEl('close-points-modal-btn'),
                viewHistory: getEl('view-history-btn'),
                closeHistory: getEl('close-history-modal-btn'),
                resetPoints: getEl('reset-points-btn'),
                manageBehaviors: getEl('manage-behaviors-btn'),
                saveBehaviors: getEl('save-behaviors-btn'),
                cancelBehaviors: getEl('cancel-behaviors-btn'),
                addNewBehavior: getEl('add-new-behavior-btn'),
                copyParentUrl: getEl('copy-parent-url-btn'),
                closeParentLink: getEl('close-parent-link-btn'),
                copyRulesCode: getEl('copy-rules-code-btn'),
                classSettings: getEl('class-settings-btn'),
                saveClassSettings: getEl('save-class-settings-btn'),
                closeClassSettings: getEl('close-class-settings-btn'),
                // Config ç›¸é—œæŒ‰éˆ•
                config: getEl('config-btn'),
                closeConfig: getEl('close-config-btn'),
                saveConfig: getEl('save-config-btn'),
                resetConfig: getEl('reset-config-btn'),
                copyConfigLink: getEl('copy-config-link-btn'),
                initConfig: getEl('init-config-btn'), // åˆå§‹ç•«é¢æŒ‰éˆ•
                initHelp: getEl('init-help-btn'), // åˆå§‹ç•«é¢æŒ‰éˆ•
            },
            inputs: {
                studentName: getEl('student-name-input'),
                avatarFile: getEl('avatar-file-input'),
                className: getEl('class-name-input'),
                configText: getEl('config-textarea'),
                configShareUrl: getEl('config-share-url'),
            },
            containers: {
                controlPanel: getEl('control-panel'),
                studentGrid: getEl('student-grid'),
                groupsGrid: getEl('groups-grid'),
                tabsContainer: getEl('tabs-container'),
                studentsView: getEl('students-view'),
                groupsView: getEl('groups-view'),
                studentsTab: getEl('students-tab'),
                groupsTab: getEl('groups-tab'),
                initialPrompt: getEl('initial-prompt'),
                loadingText: getEl('loading-text'),
                setupPrompt: getEl('setup-prompt'),
                spinner: getEl('spinner'),
                positiveBehaviors: getEl('positive-behaviors'),
                negativeBehaviors: getEl('negative-behaviors'),
                historyList: getEl('history-list'),
                behaviorListEditor: getEl('behavior-list-editor'),
                deleteStudentList: getEl('delete-student-list'),
                avatarGrid: getEl('avatar-grid'),
                shareConfigSection: getEl('share-config-section'),
            },
            sounds: {
                positive: () => new Tone.PolySynth(Tone.Synth).toDestination().triggerAttackRelease(["C5", "E5", "G5"], "8n"),
                negative: () => new Tone.Synth({ oscillator: { type: 'sawtooth' } }).toDestination().triggerAttackRelease("G2", "4n"),
                click: () => new Tone.MembraneSynth().toDestination().triggerAttackRelease("C2", "32n")
            },
            titles: {
                className: getEl('class-name-title'),
                pointsModal: getEl('points-modal-title'),
                historyModal: getEl('history-modal-title'),
            },
            icons: {
                sun: getEl('icon-sun'),
                moon: getEl('icon-moon'),
            }
        };

        // --- æ¨¡å¼æª¢æ¸¬ï¼ˆé è¨­ç‚ºå®¶é•·æ¨¡å¼ï¼‰ ---
        const urlParams = new URLSearchParams(window.location.search);
        const isTeacherMode = urlParams.get('mode') === 'teacher';
        const isParentMode = !isTeacherMode;
        
        if (isParentMode) {
            document.body.classList.add('parent-mode');
            const banner = document.createElement('div');
            banner.className = 'parent-mode-banner';
            banner.textContent = 'ğŸ‘€ æª¢è¦–æ¨¡å¼ (View Only)';
            document.body.insertBefore(banner, document.body.firstChild);
        }

        // --- ç‹€æ…‹ç®¡ç† ---
        let state = {
            students: [],
            behaviors: [],
            groups: {},
            isLoading: true,
            currentStudentId: null,
            currentGroupName: null,
            className: 'Classroom Points!',
            sortOrder: 'byName',
            activeTab: 'students',
            isParentMode: isParentMode,
            isTeacherMode: isTeacherMode,
            currentUploadingStudentId: null,
            unsubscribeListeners: [],
            theme: localStorage.getItem('theme') || 'dark'
        };

        // --- ä¸»é¡Œåˆ‡æ›é‚è¼¯ ---
        const applyTheme = (theme) => {
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                app.icons.sun.classList.remove('hidden');
                app.icons.moon.classList.add('hidden');
            } else {
                document.documentElement.removeAttribute('data-theme');
                app.icons.sun.classList.add('hidden');
                app.icons.moon.classList.remove('hidden');
            }
            state.theme = theme;
            localStorage.setItem('theme', theme);
        };

        const toggleTheme = () => {
            playSound(app.sounds.click);
            const newTheme = state.theme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        };

        // åˆå§‹åŒ–ä¸»é¡Œ
        applyTheme(state.theme);

        // --- é€šç”¨å‡½å¼ ---
        const toggleModal = (modal, show) => {
            modal.classList.toggle('hidden', !show);
        };

        const playSound = (soundPlayer) => {
            if (typeof Tone === 'undefined') return;
            if (Tone.context.state !== 'running') {
                Tone.start().catch(e => console.error("Tone.js context ç„¡æ³•å•Ÿå‹•", e));
            }
            try {
                soundPlayer();
            } catch (e) {
                console.error("éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", e);
            }
        };

        const exportToCsv = (studentData, filename) => {
            let csvContent = "data:text/csv;charset=utf-8,\ufeff";
            csvContent += "åˆ†çµ„,å­¸ç”Ÿå§“å,ç¸½å¾—åˆ†\n";
            studentData.forEach(student => {
                const group = student.group || 'æœªåˆ†çµ„';
                csvContent += `"${group}","${student.name}",${student.points}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- æ¸²æŸ“å‡½å¼ ---
        const setLoading = (isLoading) => {
            state.isLoading = isLoading;
            const hasStudents = state.students && state.students.length > 0;
            app.containers.initialPrompt.classList.toggle('hidden', !isLoading && hasStudents);
            if (isLoading) {
                app.containers.loadingText.textContent = "Connecting...";
                app.containers.spinner.classList.remove('hidden');
                app.containers.setupPrompt.classList.add('hidden');
            }
        };
        
        const generateAvatar = (seed) => {
            const S = (s) => { let h = 0; for(let i=0; i<s.length; i++) h = (Math.imul(31, h) + s.charCodeAt(i)) | 0; return h; };
            const R = (s) => { s = Math.sin(s) * 10000; return s - Math.floor(s); };
            const seedNum = S(seed);
            
            const colors = ['#f472b6', '#60a5fa', '#facc15', '#4ade80', '#a78bfa', '#fb923c'];
            const bgColor = colors[Math.floor(R(seedNum) * colors.length)];
            
            return `data:image/svg+xml,${encodeURIComponent(`
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:${bgColor};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:${bgColor};stop-opacity:0.6" />
                        </linearGradient>
                    </defs>
                    <rect width="100" height="100" rx="30" fill="url(#grad)" />
                    <circle cx="50" cy="40" r="15" fill="white" fill-opacity="0.9" />
                    <path d="M20 90 Q 50 50, 80 90" stroke="white" stroke-width="0" fill="white" fill-opacity="0.9" />
                </svg>`)}`;
        };

        const switchTab = (tabName) => {
            state.activeTab = tabName;
            app.containers.studentsTab.classList.toggle('active-tab', tabName === 'students');
            app.containers.groupsTab.classList.toggle('active-tab', tabName === 'groups');
            app.containers.studentsView.classList.toggle('hidden', tabName !== 'students');
            app.containers.groupsView.classList.toggle('hidden', tabName !== 'groups');
            if (tabName === 'groups') renderGroupsGrid();
        };

        const renderStudentGrid = () => {
            if (!state.students) return;
            app.containers.studentGrid.innerHTML = '';
            if (state.students.length === 0 && !state.isLoading) {
                 app.containers.initialPrompt.classList.remove('hidden');
                 app.containers.loadingText.textContent = "ç­ç´šé‚„æ˜¯ç©ºçš„";
                 app.containers.setupPrompt.classList.add('hidden'); // Ensure setup prompt is hidden if connected but empty
                 app.containers.setupPrompt.innerHTML = ""; // Clear any old content
                 const emptyMsg = document.createElement('div');
                 emptyMsg.innerHTML = `<p class="mt-4 text-gray-300">è«‹é»æ“Šä¸Šæ–¹çš„ ğŸ§‘â€ğŸ« æŒ‰éˆ•ï¼Œé–‹å§‹ç®¡ç†å­¸ç”Ÿã€‚</p>`;
                 app.containers.initialPrompt.appendChild(emptyMsg);
                 app.containers.spinner.classList.add('hidden');
                 return;
            }
            
            let sortedStudents = [...state.students];
            if (state.sortOrder === 'byName') {
                sortedStudents.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            } else if (state.sortOrder === 'byPoints') {
                sortedStudents.sort((a, b) => b.points - a.points);
            } else if (state.sortOrder === 'byGroup') {
                sortedStudents.sort((a, b) => {
                    const groupA = a.group || '';
                    const groupB = b.group || '';
                    if (groupA === groupB) return a.name.localeCompare(b.name, 'zh-Hant');
                    return groupA.localeCompare(groupB, 'zh-Hant');
                });
            }
            
            sortedStudents.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card glass-panel rounded-2xl p-4 flex flex-col items-center cursor-pointer relative overflow-hidden';
                card.dataset.studentId = student.id;

                const pointChangeEl = document.createElement('div');
                pointChangeEl.className = 'point-change-indicator absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-5xl font-black font-exo pointer-events-none opacity-0 z-20';
                
                const avatar = document.createElement('img');
                avatar.src = student.avatar || generateAvatar(student.name);
                avatar.alt = student.name;
                avatar.className = 'w-20 h-20 rounded-2xl shadow-lg mb-3 object-cover border-2 border-white/20';

                const nameContainer = document.createElement('div');
                nameContainer.className = 'text-center w-full z-10';
                
                if (student.group) {
                    nameContainer.innerHTML = `<p class="font-bold text-lg text-white truncate"><span class="text-xs text-blue-300 font-light block mb-1">${student.group}</span>${student.name}</p>`;
                } else {
                    nameContainer.innerHTML = `<p class="font-bold text-center text-lg text-white truncate w-full mt-2">${student.name}</p>`;
                }

                const points = document.createElement('p');
                points.className = `font-exo text-4xl font-black mt-2 drop-shadow-lg transition-colors duration-300 ${student.points >= 0 ? 'text-green-400' : 'text-red-400'}`;
                points.textContent = student.points;
                points.id = `points-${student.id}`;
                
                const glow = document.createElement('div');
                glow.className = 'absolute top-0 left-0 w-full h-full bg-gradient-to-b from-transparent to-black/20 pointer-events-none';

                card.append(pointChangeEl, avatar, nameContainer, points, glow);
                card.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    openPointsModal(student.id);
                });
                app.containers.studentGrid.appendChild(card);
            });
        };

        const renderGroupsGrid = () => {
            app.containers.groupsGrid.innerHTML = '';
            const groups = {};
            state.students.forEach(student => {
                const groupName = student.group || 'æœªåˆ†çµ„';
                if (!groups[groupName]) groups[groupName] = [];
                groups[groupName].push(student);
            });
            
            if (Object.keys(groups).length === 0 || (Object.keys(groups).length === 1 && groups['æœªåˆ†çµ„'])) {
                app.containers.groupsGrid.innerHTML = '<p class="text-center text-gray-400 p-8 col-span-full text-lg">æ²’æœ‰åˆ†çµ„è³‡æ–™ã€‚</p>';
                return;
            }
            
            const groupGradients = [
                'from-pink-500/20 to-rose-500/20', 'from-blue-500/20 to-cyan-500/20', 'from-emerald-500/20 to-teal-500/20', 
                'from-amber-500/20 to-orange-500/20', 'from-violet-500/20 to-purple-500/20'
            ];
            
            Object.entries(groups).forEach(([groupName, students], index) => {
                if (groupName === 'æœªåˆ†çµ„' && Object.keys(groups).length > 1) return;
                const groupCard = document.createElement('div');
                const gradClass = groupGradients[index % groupGradients.length];
                groupCard.className = `group-card glass-panel bg-gradient-to-br ${gradClass} rounded-2xl p-6 cursor-pointer hover:border-white/40 transition-all hover:-translate-y-1 relative overflow-hidden`;
                
                const totalPoints = students.reduce((sum, s) => sum + s.points, 0);
                const avgPoints = students.length > 0 ? Math.round(totalPoints / students.length) : 0;
                
                let studentListHtml = '';
                students.forEach(student => {
                    studentListHtml += `<div class="flex justify-between items-center py-2 px-3 bg-black/20 rounded-lg mb-2 border border-white/5"><span class="font-medium text-gray-200">${student.name}</span><span class="font-exo font-bold ${student.points >=0 ? 'text-green-400' : 'text-red-400'}">${student.points}</span></div>`;
                });

                groupCard.innerHTML = `
                    <h3 class="font-exo text-2xl mb-4 text-center font-bold text-white tracking-wider border-b border-white/10 pb-2">${groupName}</h3>
                    <div class="mb-4 max-h-48 overflow-y-auto custom-scrollbar pr-1">${studentListHtml}</div>
                    <div class="grid grid-cols-3 gap-2 text-center pt-2 border-t border-white/10">
                        <div><p class="text-xs text-gray-400 uppercase">äººæ•¸</p><p class="font-bold text-white text-lg">${students.length}</p></div>
                        <div><p class="text-xs text-gray-400 uppercase">ç¸½åˆ†</p><p class="font-bold text-blue-300 text-lg">${totalPoints}</p></div>
                        <div><p class="text-xs text-gray-400 uppercase">å¹³å‡</p><p class="font-bold text-purple-300 text-lg">${avgPoints}</p></div>
                    </div>
                `;
                groupCard.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    openGroupPointsModal(groupName, students);
                });
                app.containers.groupsGrid.appendChild(groupCard);
            });
        };
        
        const renderStudentDeletionList = () => {
            app.containers.deleteStudentList.innerHTML = '';
            if (state.students.length === 0) {
                app.containers.deleteStudentList.innerHTML = '<p class="text-center text-gray-500 p-4">ç›®å‰æ²’æœ‰å­¸ç”Ÿã€‚</p>';
                return;
            }
            
            let sortedStudents = [...state.students].sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            sortedStudents.forEach(student => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white/5 p-3 rounded-lg mb-2 border border-white/10';
                item.innerHTML = `<span class="font-bold text-gray-200">${student.name}</span><button data-id="${student.id}" class="delete-student-btn bg-red-500/80 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded shadow transition-colors">åˆªé™¤</button>`;
                app.containers.deleteStudentList.appendChild(item);
            });
            
            document.querySelectorAll('.delete-student-btn').forEach(button => {
                button.addEventListener('click', handleDeleteStudent);
            });
        };

        // --- Config Modal Logic ---
        const openConfigModal = () => {
            playSound(app.sounds.click);
            // å¡«å…¥ç•¶å‰è¨­å®šåˆ° textarea (å¦‚æœæ˜¯ demo å‰‡ç•™ç©ºæˆ–é¡¯ç¤º placeholder)
            if (activeConfig) {
                 // é€™è£¡åªåšé¡¯ç¤ºï¼Œç‚ºäº†å®‰å…¨æˆ–æ–¹ä¾¿ï¼Œå¯ä»¥é¸æ“‡ä¸é¡¯ç¤º Keyï¼Œä½†ç‚ºäº†è®“ä½¿ç”¨è€…å¥½ä¿®æ”¹ï¼Œæˆ‘å€‘å°‡å…¶é‚„åŸç‚ºå­—ä¸²
                 app.inputs.configText.value = Object.entries(activeConfig)
                    .map(([k, v]) => `${k}: "${v}"`)
                    .join(',\n');
                 
                 // ç”Ÿæˆåˆ†äº«é€£çµèˆ‡ QR Code
                 const configString = JSON.stringify(activeConfig);
                 const base64Config = btoa(configString);
                 
                 // åˆ¤æ–·ç•¶å‰æ¨¡å¼
                 const currentMode = isTeacherMode ? 'teacher' : 'parent';
                 const shareUrl = `${window.location.origin}${window.location.pathname}?config=${base64Config}&mode=${currentMode}`;
                 
                 app.inputs.configShareUrl.value = shareUrl;
                 app.containers.shareConfigSection.classList.remove('hidden');
                 
                 // ç”Ÿæˆ Config QR Code
                 try {
                     if (typeof qrcode !== 'undefined') {
                         const qr = qrcode(0, 'L'); // 'L' error correction for longer data
                         qr.addData(shareUrl);
                         qr.make();
                         const canvas = getEl('config-qr-canvas');
                         canvas.width = 120;
                         canvas.height = 120;
                         qr.renderTo2dContext(canvas.getContext('2d'), 5);
                     }
                 } catch (e) {
                     console.error('Config QR Gen Error', e);
                 }

            } else {
                app.inputs.configText.value = '';
                app.containers.shareConfigSection.classList.add('hidden');
            }
            toggleModal(app.modals.config, true);
        };

        const handleSaveConfig = () => {
            const text = app.inputs.configText.value;
            const newConfig = {};
            
            // å¯¬é¬†è§£æé‚è¼¯ï¼šå°‹æ‰¾ key: "value" æˆ– key: 'value'
            const keys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
            let found = false;

            keys.forEach(key => {
                // Regex èªªæ˜: åŒ¹é… keyï¼Œå†’è™Ÿï¼Œå¯èƒ½çš„ç©ºç™½ï¼Œå¼•è™Ÿï¼Œå€¼(éå¼•è™Ÿ)ï¼Œå¼•è™Ÿ
                const regex = new RegExp(`${key}\\s*:\\s*["']([^"']+)["']`);
                const match = text.match(regex);
                if (match && match[1]) {
                    newConfig[key] = match[1];
                    found = true;
                }
            });

            if (found && newConfig.apiKey && newConfig.projectId) {
                localStorage.setItem('firebaseConfig', JSON.stringify(newConfig));
                alert('è¨­å®šå·²å„²å­˜ï¼é é¢å°‡é‡æ–°æ•´ç†ä»¥é€£ç·šã€‚');
                window.location.reload();
            } else {
                alert('è§£æå¤±æ•—ï¼è«‹ç¢ºä¿æ‚¨è²¼ä¸Šäº†åŒ…å« apiKey å’Œ projectId çš„æ­£ç¢ºè¨­å®šå…§å®¹ã€‚\n(è«‹ä¸è¦åŒ…å«å¤–å±¤çš„ const firebaseConfig = { ... })');
            }
        };

        const handleResetConfig = () => {
            if(confirm('ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿçš„ Firebase è¨­å®šå—ï¼Ÿ\næ¸…é™¤å¾Œå°‡å›åˆ°æœªè¨­å®šç‹€æ…‹ã€‚')) {
                localStorage.removeItem('firebaseConfig');
                window.location.reload();
            }
        };
        
        const copyConfigLink = async () => {
            try {
                await navigator.clipboard.writeText(app.inputs.configShareUrl.value);
                alert('å·²è¤‡è£½åˆ†äº«é€£çµï¼');
            } catch (err) {
                alert('è¤‡è£½å¤±æ•—');
            }
        };


        // --- å…¶ä»– Modal é–‹å•Ÿ/é—œé–‰é‚è¼¯ ---
        const openManageStudentModal = () => {
            playSound(app.sounds.click);
            app.inputs.studentName.value = '';
            renderStudentDeletionList();
            toggleModal(app.modals.manageStudent, true);
            app.inputs.studentName.focus();
        };

        const openGroupPointsModal = (groupName, students) => {
            if (!state.isTeacherMode) return;
            state.currentGroupName = groupName;
            state.currentStudentId = null;
            app.titles.pointsModal.textContent = `çµ¦ ${groupName} é»æ•¸`;
            
            app.containers.positiveBehaviors.innerHTML = '';
            app.containers.negativeBehaviors.innerHTML = '';
            state.behaviors.forEach(b => {
                const btn = document.createElement('button');
                const pointsText = b.points > 0 ? `+${b.points}` : b.points;
                btn.className = `w-full modern-btn rounded-xl p-3 font-bold text-left flex justify-between items-center mb-2 shadow-sm border border-white/10 transition-transform hover:scale-[1.02] ${b.type === 'positive' ? 'bg-gradient-to-r from-emerald-500/80 to-teal-600/80 text-white' : 'bg-gradient-to-r from-red-500/80 to-rose-600/80 text-white'}`;
                btn.innerHTML = `<span>${b.name}</span> <span class="text-xl font-exo bg-black/20 px-2 rounded">${pointsText}</span>`;
                btn.addEventListener('click', () => awardGroupPoints(b, students));
                if (b.type === 'positive') app.containers.positiveBehaviors.appendChild(btn);
                else app.containers.negativeBehaviors.appendChild(btn);
            });
            
            app.buttons.viewHistory.style.display = 'none';
            toggleModal(app.modals.points, true);
        };

        const openPointsModal = (studentId) => {
            if (!state.isTeacherMode) return;
            state.currentStudentId = studentId;
            state.currentGroupName = null;
            const student = state.students.find(s => s.id === studentId);
            if (!student) return;

            app.titles.pointsModal.textContent = `çµ¦ ${student.name} é»æ•¸`;
            app.buttons.viewHistory.style.display = 'inline-block';
            
            app.containers.positiveBehaviors.innerHTML = '';
            app.containers.negativeBehaviors.innerHTML = '';
            state.behaviors.forEach(b => {
                const btn = document.createElement('button');
                const pointsText = b.points > 0 ? `+${b.points}` : b.points;
                btn.className = `w-full modern-btn rounded-xl p-3 font-bold text-left flex justify-between items-center mb-2 shadow-sm border border-white/10 transition-transform hover:scale-[1.02] ${b.type === 'positive' ? 'bg-gradient-to-r from-emerald-500/80 to-teal-600/80 text-white' : 'bg-gradient-to-r from-red-500/80 to-rose-600/80 text-white'}`;
                btn.innerHTML = `<span>${b.name}</span> <span class="text-xl font-exo bg-black/20 px-2 rounded">${pointsText}</span>`;
                btn.addEventListener('click', () => awardPoints(b));
                if (b.type === 'positive') app.containers.positiveBehaviors.appendChild(btn);
                else app.containers.negativeBehaviors.appendChild(btn);
            });
            toggleModal(app.modals.points, true);
        };

        const openHistoryModal = async () => {
            const student = state.students.find(s => s.id === state.currentStudentId);
            app.titles.historyModal.textContent = `${student.name} çš„æ­·å²ç´€éŒ„`;
            app.containers.historyList.innerHTML = '<div class="flex justify-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-white"></div></div>';
            toggleModal(app.modals.history, true);
            
            try {
                const snapshot = await db.collection('logs')
                    .where('studentId', '==', state.currentStudentId)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const history = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { ...data, timestamp: data.timestamp ? data.timestamp.toDate().toLocaleString('zh-TW') : 'N/A' };
                });

                app.containers.historyList.innerHTML = '';
                if (history.length === 0) {
                    app.containers.historyList.innerHTML = '<p class="text-center p-4 text-gray-400">æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚</p>';
                    return;
                }
                history.forEach(log => {
                    const item = document.createElement('div');
                    item.className = `p-3 rounded-lg mb-2 flex justify-between items-center border border-white/5 ${log.points > 0 ? 'bg-green-500/20' : 'bg-red-500/20'}`;
                    const pointsText = log.points > 0 ? `+${log.points}` : log.points;
                    item.innerHTML = `<div><p class="font-bold text-gray-200">${log.behaviorName}</p><p class="text-xs text-gray-400">${log.timestamp}</p></div><p class="font-exo text-2xl font-bold ${log.points > 0 ? 'text-green-400' : 'text-red-400'}">${pointsText}</p>`;
                    app.containers.historyList.appendChild(item);
                });
            } catch (error) {
                console.error("è®€å–æ­·å²ç´€éŒ„å¤±æ•—:", error);
                app.containers.historyList.innerHTML = '<p class="text-center p-4 text-red-400">è®€å–ç´€éŒ„å¤±æ•—ã€‚</p>';
            }
        };

        const openManageBehaviorsModal = () => {
            app.containers.behaviorListEditor.innerHTML = '';
            state.behaviors.forEach((b, index) => addBehaviorEditorRow(b, index));
            toggleModal(app.modals.manageBehaviors, true);
        };

        const addBehaviorEditorRow = (behavior = { name: '', points: 1, type: 'positive' }, index) => {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 p-3 bg-black/20 rounded-xl border border-white/10';
            div.innerHTML = `
                <input type="text" value="${behavior.name}" class="behavior-name-input flex-grow p-2 bg-black/30 border border-white/20 rounded text-white placeholder-gray-500" placeholder="è¡Œç‚ºåç¨±">
                <input type="number" value="${behavior.points}" class="behavior-points-input w-20 p-2 bg-black/30 border border-white/20 rounded text-white text-center">
                <select class="behavior-type-select p-2 bg-black/30 border border-white/20 rounded text-white">
                    <option value="positive" ${behavior.type === 'positive' ? 'selected' : ''}>åŠ åˆ†</option>
                    <option value="negative" ${behavior.type === 'negative' ? 'selected' : ''}>æ‰£åˆ†</option>
                </select>
                <button class="remove-behavior-btn text-red-400 hover:text-red-300 font-bold text-xl p-2 transition-colors">âœ–</button>
            `;
            app.containers.behaviorListEditor.appendChild(div);
            div.querySelector('.remove-behavior-btn').addEventListener('click', () => div.remove());
        };

        // --- åœ–ç‰‡å£“ç¸®åŠŸèƒ½ ---
        const compressImage = (file, maxWidth = 200) => {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    const ratio = Math.min(maxWidth / img.width, 1);
                    const newWidth = img.width * ratio;
                    const newHeight = img.height * ratio;
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = URL.createObjectURL(file);
            });
        };

        // --- é ­åƒç®¡ç†åŠŸèƒ½ ---
        const openAvatarsModal = () => {
            playSound(app.sounds.click);
            renderAvatarGrid();
            toggleModal(app.modals.manageAvatars, true);
        };

        const renderAvatarGrid = () => {
            app.containers.avatarGrid.innerHTML = '';
            if (state.students.length === 0) {
                app.containers.avatarGrid.innerHTML = '<p class="text-center text-gray-400 p-8 col-span-full">ç›®å‰æ²’æœ‰å­¸ç”Ÿè³‡æ–™ã€‚</p>';
                return;
            }
            const sortedStudents = [...state.students].sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            sortedStudents.forEach(student => {
                const avatarCard = document.createElement('div');
                avatarCard.className = 'bg-white/5 border border-white/10 rounded-xl p-4 text-center cursor-pointer hover:bg-white/10 transition-colors group';
                avatarCard.innerHTML = `
                    <div class="relative mb-3 inline-block">
                        <img src="${student.avatar || generateAvatar(student.name)}" alt="${student.name}" class="w-16 h-16 rounded-xl object-cover shadow-lg mx-auto">
                        <div class="absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity rounded-xl">
                            <span class="text-white text-xs font-bold">æ›´æ›</span>
                        </div>
                    </div>
                    <p class="font-bold text-sm text-gray-200">${student.name}</p>
                    <p class="text-xs text-gray-500 mt-1">${student.group || ''}</p>
                `;
                avatarCard.addEventListener('click', () => {
                    state.currentUploadingStudentId = student.id;
                    app.inputs.avatarFile.click();
                });
                app.containers.avatarGrid.appendChild(avatarCard);
            });
        };
        
        // --- ç­ç´šè¨­å®šåŠŸèƒ½ ---
        const openClassSettingsModal = () => {
            playSound(app.sounds.click);
            app.inputs.className.value = state.className;
            toggleModal(app.modals.classSettings, true);
        };

        const handleSaveClassSettings = async () => {
            const newName = app.inputs.className.value.trim();
            if (!newName) {
                alert('ç­ç´šåç¨±ä¸èƒ½ç‚ºç©º');
                return;
            }
            
            playSound(app.sounds.click);
            try {
                await db.collection('config').doc('main').set({ className: newName }, { merge: true });
                toggleModal(app.modals.classSettings, false);
                
                const toast = document.createElement('div');
                toast.className = 'fixed top-6 right-6 bg-green-500 text-white p-3 rounded-xl font-bold z-50 shadow-lg';
                toast.textContent = 'âœ… è¨­å®šå·²å„²å­˜';
                document.body.appendChild(toast);
                setTimeout(() => document.body.removeChild(toast), 2000);
            } catch (error) {
                console.error("å„²å­˜è¨­å®šå¤±æ•—:", error);
                alert("å„²å­˜è¨­å®šå¤±æ•—");
            }
        };

        // --- äº‹ä»¶è™•ç† ---
        const handleAddStudents = async () => {
            const lines = app.inputs.studentName.value.trim().split('\n').map(n => n.trim()).filter(n => n);
            if (lines.length === 0) {
                alert('è«‹è‡³å°‘è¼¸å…¥ä¸€ä½å­¸ç”Ÿå§“åï¼');
                return;
            }
            playSound(app.sounds.click);
            const batch = db.batch();
            const studentsPayload = lines.map(line => {
                let name, group = '';
                const separator = line.includes(',') ? ',' : (line.includes('\t') ? '\t' : null);
                if (separator) {
                    [name, group] = line.split(separator).map(s => s.trim());
                } else {
                    name = line;
                }
                return { name, group: group || '', avatar: generateAvatar(name), points: 0 };
            });

            studentsPayload.forEach(student => {
                const docRef = db.collection('students').doc();
                batch.set(docRef, student);
            });

            try {
                await batch.commit();
                app.inputs.studentName.value = '';
                alert(`${lines.length} ä½å­¸ç”Ÿå·²æˆåŠŸæ–°å¢ï¼`);
                if (studentsPayload.some(s => s.group)) {
                    app.containers.tabsContainer.classList.remove('hidden');
                }
            } catch (error) {
                console.error("æ–°å¢å­¸ç”Ÿå¤±æ•—:", error);
                alert("æ–°å¢å­¸ç”Ÿå¤±æ•—ã€‚");
            }
        };
        
        const handleDeleteStudent = async (event) => {
            const studentId = event.target.dataset.id;
            const student = state.students.find(s => s.id === studentId);
            if (!student) return;

            playSound(app.sounds.negative);
            if (confirm(`ç¢ºå®šè¦åˆªé™¤å­¸ç”Ÿã€Œ${student.name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                try {
                    await db.collection('students').doc(studentId).delete();
                } catch (error) {
                    console.error("åˆªé™¤å­¸ç”Ÿå¤±æ•—:", error);
                }
            }
        };

        const awardPoints = async (behavior) => {
            const { name, points } = behavior;
            playSound(points > 0 ? app.sounds.positive : app.sounds.negative);
            toggleModal(app.modals.points, false);

            const studentCard = document.querySelector(`[data-student-id="${state.currentStudentId}"]`);
            if(studentCard) {
                const indicator = studentCard.querySelector('.point-change-indicator');
                indicator.textContent = points > 0 ? `+${points}` : points;
                indicator.style.color = points > 0 ? '#4ade80' : '#f87171';
                indicator.classList.remove('point-change-up', 'point-change-down');
                void indicator.offsetWidth;
                indicator.classList.add(points > 0 ? 'point-change-up' : 'point-change-down');
            }

            const studentRef = db.collection('students').doc(state.currentStudentId);
            const logRef = db.collection('logs').doc();
            try {
                const batch = db.batch();
                batch.update(studentRef, { points: firebase.firestore.FieldValue.increment(Number(points)) });
                batch.set(logRef, {
                    studentId: state.currentStudentId,
                    studentName: state.students.find(s => s.id === state.currentStudentId).name,
                    behaviorName: name,
                    points: Number(points),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                await batch.commit();
            } catch (error) {
                console.error("æ›´æ–°é»æ•¸å¤±æ•—:", error);
            }
        };

        const awardGroupPoints = async (behavior, students) => {
            const { name, points } = behavior;
            playSound(points > 0 ? app.sounds.positive : app.sounds.negative);
            toggleModal(app.modals.points, false);

            const successToast = document.createElement('div');
            successToast.className = 'fixed top-6 right-6 bg-gradient-to-r from-emerald-500 to-teal-500 text-white p-4 rounded-xl font-bold shadow-2xl z-50 animate-bounce';
            successToast.textContent = `âš¡ å·²ç‚º ${state.currentGroupName} å…¨é«” ${points > 0 ? '+' : ''}${points} åˆ†ï¼`;
            document.body.appendChild(successToast);
            setTimeout(() => document.body.removeChild(successToast), 3000);

            const batch = db.batch();
            students.forEach(student => {
                const studentRef = db.collection('students').doc(student.id);
                batch.update(studentRef, { points: firebase.firestore.FieldValue.increment(Number(points)) });
                const logRef = db.collection('logs').doc();
                batch.set(logRef, {
                    studentId: student.id,
                    studentName: student.name,
                    behaviorName: `[åˆ†çµ„] ${name}`,
                    points: Number(points),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            try {
                await batch.commit();
            } catch (error) {
                console.error("åˆ†çµ„æ›´æ–°é»æ•¸å¤±æ•—:", error);
            }
        };

        const handleExportLogs = async () => {
            playSound(app.sounds.click);
            const loadingToast = document.createElement('div');
            loadingToast.className = 'fixed top-6 right-6 bg-blue-600 text-white p-4 rounded-xl font-bold z-50 shadow-lg';
            loadingToast.textContent = 'â³ æ­£åœ¨åŒ¯å‡ºç´€éŒ„...';
            document.body.appendChild(loadingToast);

            try {
                const snapshot = await db.collection('logs').orderBy('timestamp', 'desc').get();
                let csvContent = "\uFEFFæ™‚é–“,å­¸ç”Ÿå§“å,è¡Œç‚ºé …ç›®,é»æ•¸\n"; // BOM for Excel

                snapshot.docs.forEach(doc => {
                    const d = doc.data();
                    const date = d.timestamp ? d.timestamp.toDate().toLocaleString('zh-TW') : 'N/A';
                    const name = (d.studentName || '').replace(/"/g, '""');
                    const behavior = (d.behaviorName || '').replace(/"/g, '""');
                    csvContent += `"${date}","${name}","${behavior}",${d.points}\n`;
                });

                const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${state.className}_å®Œæ•´ç´€éŒ„.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                document.body.removeChild(loadingToast);
                toggleModal(app.modals.export, false);
            } catch (error) {
                console.error("åŒ¯å‡ºå¤±æ•—:", error);
                document.body.removeChild(loadingToast);
                alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase è¨­å®šã€‚');
            }
        };

        const handleResetPoints = async () => {
            playSound(app.sounds.negative);
            if (!confirm('âš ï¸ åš´é‡è­¦å‘Šï¼š\n\næ­¤æ“ä½œå°‡æœƒï¼š\n1. å°‡æ‰€æœ‰å­¸ç”Ÿé»æ•¸æ­¸é›¶\n2. ã€Œåˆªé™¤ã€æ‰€æœ‰æ­·å²åŠ æ‰£åˆ†ç´€éŒ„\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ')) return;

            const loadingToast = document.createElement('div');
            loadingToast.className = 'fixed top-6 right-6 bg-red-600 text-white p-4 rounded-xl font-bold z-50 shadow-lg';
            loadingToast.textContent = 'â³ æ­£åœ¨é‡è¨­ç³»çµ±èˆ‡åˆªé™¤ç´€éŒ„...';
            document.body.appendChild(loadingToast);

            try {
                // 1. Reset Students Points
                let batch = db.batch();
                state.students.forEach(student => {
                    const studentRef = db.collection('students').doc(student.id);
                    batch.update(studentRef, { points: 0 });
                });
                await batch.commit();

                // 2. Delete Logs (Handling batch limits by chunking)
                const logsSnapshot = await db.collection('logs').get();
                const chunks = [];
                let currentBatch = db.batch();
                let count = 0;

                logsSnapshot.docs.forEach((doc) => {
                    currentBatch.delete(doc.ref);
                    count++;
                    if (count >= 450) { // Safety margin below 500 limit
                        chunks.push(currentBatch.commit());
                        currentBatch = db.batch();
                        count = 0;
                    }
                });
                if (count > 0) chunks.push(currentBatch.commit());
                await Promise.all(chunks);

                // 3. Add System Reset Log
                await db.collection('logs').add({
                    studentId: 'SYSTEM',
                    behaviorName: 'ç³»çµ±é‡è¨­ (é»æ•¸èˆ‡ç´€éŒ„å·²æ¸…ç©º)',
                    points: 0,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.body.removeChild(loadingToast);
                alert('ç³»çµ±å·²å®Œå…¨é‡è¨­ï¼æ‰€æœ‰é»æ•¸å·²æ­¸é›¶ï¼Œæ­·å²ç´€éŒ„å·²æ¸…é™¤ã€‚');
            } catch (error) {
                console.error("é‡è¨­å¤±æ•—:", error);
                document.body.removeChild(loadingToast);
                alert("é‡è¨­éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°ã€‚");
            }
        };

        const handleSaveBehaviors = async () => {
            const behaviorElements = app.containers.behaviorListEditor.querySelectorAll('.flex.items-center.gap-2');
            const newBehaviors = [];
            let isValid = true;
            behaviorElements.forEach(el => {
                const name = el.querySelector('.behavior-name-input').value.trim();
                const points = el.querySelector('.behavior-points-input').value;
                const type = el.querySelector('.behavior-type-select').value;
                if (name && points) {
                    newBehaviors.push({ name, points: Number(points), type });
                } else {
                    isValid = false;
                }
            });

            if (!isValid) {
                alert('è«‹å®Œæ•´å¡«å¯«è¡Œç‚ºåç¨±å’Œé»æ•¸ã€‚');
                return;
            }

            try {
                const batch = db.batch();
                const snapshot = await db.collection('behaviors').get();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                newBehaviors.forEach(b => {
                    const docRef = db.collection('behaviors').doc();
                    batch.set(docRef, b);
                });
                await batch.commit();
                toggleModal(app.modals.manageBehaviors, false);
            } catch (error) {
                console.error("å„²å­˜è¡Œç‚ºå¤±æ•—:", error);
            }
        };

        const handleAvatarUpload = async (event) => {
            const file = event.target.files[0];
            if (!file || !state.currentUploadingStudentId) return;
            const student = state.students.find(s => s.id === state.currentUploadingStudentId);
            if (!student) return;
            
            const uploadToast = document.createElement('div');
            uploadToast.className = 'fixed top-6 right-6 bg-blue-600 text-white p-3 rounded-xl font-bold z-50 shadow-lg';
            uploadToast.textContent = `â³ ä¸Šå‚³é ­åƒä¸­...`;
            document.body.appendChild(uploadToast);
            
            try {
                const compressedImage = await compressImage(file, 200);
                await db.collection('students').doc(state.currentUploadingStudentId).update({ avatar: compressedImage });
                document.body.removeChild(uploadToast);
            } catch (error) {
                console.error('é ­åƒä¸Šå‚³å¤±æ•—:', error);
                document.body.removeChild(uploadToast);
                alert('ä¸Šå‚³å¤±æ•—');
            }
            event.target.value = '';
            state.currentUploadingStudentId = null;
        };

        const generateParentLink = () => {
            // ç”Ÿæˆå®¶é•·é€£çµ (ç§»é™¤ mode=teacher)
            const url = new URL(window.location.href);
            url.searchParams.delete('mode');
            
            // å¦‚æœæœ‰ configï¼ŒåŠ ä¸Š config (ç‚ºäº†è®“å®¶é•·ä¹Ÿèƒ½é€£ç·š)
            if (activeConfig) {
                 const base64Config = btoa(JSON.stringify(activeConfig));
                 url.searchParams.set('config', base64Config);
            }
            return url.toString();
        };

        const openParentLinkModal = () => {
            playSound(app.sounds.click);
            const parentUrl = generateParentLink();
            getEl('parent-url-display').value = parentUrl;
            const canvas = getEl('qr-canvas');
            try {
                if (typeof qrcode === 'undefined') throw new Error('QRç¢¼åº«æœªè¼‰å…¥');
                const qr = qrcode(0, 'M');
                qr.addData(parentUrl);
                qr.make();
                canvas.width = 150;
                canvas.height = 150;
                qr.renderTo2dContext(canvas.getContext('2d'), 5);
            } catch (error) {
                console.error('QRç¢¼ç”Ÿæˆå¤±æ•—:', error);
            }
            toggleModal(app.modals.parentLink, true);
        };

        const copyParentUrl = async () => {
            const urlInput = getEl('parent-url-display');
            try {
                await navigator.clipboard.writeText(urlInput.value);
                const btn = app.buttons.copyParentUrl;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²è¤‡è£½é€£çµ';
                btn.style.backgroundImage = 'linear-gradient(to right, #10b981, #059669)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundImage = '';
                }, 2000);
                playSound(app.sounds.positive);
            } catch (err) {
                alert('è¤‡è£½å¤±æ•—');
            }
        };

        // --- äº‹ä»¶ç›£è½å™¨è¨­å®š (åˆ†ç‚ºéœæ…‹èˆ‡å‹•æ…‹) ---

        const setupStaticEventListeners = () => {
            app.buttons.help.addEventListener('click', () => {
                playSound(app.sounds.click);
                toggleModal(app.modals.help, true);
            });
            app.buttons.closeHelp.addEventListener('click', () => toggleModal(app.modals.help, false));
            app.buttons.copyRulesCode.addEventListener('click', () => {
                const code = getEl('rules-code-block').innerText;
                navigator.clipboard.writeText(code).then(() => {
                    app.buttons.copyRulesCode.textContent = 'å·²è¤‡è£½ï¼';
                    setTimeout(() => { app.buttons.copyRulesCode.textContent = 'è¤‡è£½'; }, 2000);
                });
            });

            // Config Listeners
            app.buttons.config.addEventListener('click', openConfigModal);
            app.buttons.closeConfig.addEventListener('click', () => toggleModal(app.modals.config, false));
            app.buttons.saveConfig.addEventListener('click', handleSaveConfig);
            app.buttons.resetConfig.addEventListener('click', handleResetConfig);
            app.buttons.copyConfigLink.addEventListener('click', copyConfigLink);
            app.buttons.initConfig.addEventListener('click', openConfigModal);
            app.buttons.initHelp.addEventListener('click', () => toggleModal(app.modals.help, true));

            app.buttons.closeManageStudent.addEventListener('click', () => toggleModal(app.modals.manageStudent, false));
            app.buttons.closeAvatars.addEventListener('click', () => toggleModal(app.modals.manageAvatars, false));
            app.buttons.cancelExport.addEventListener('click', () => toggleModal(app.modals.export, false));
            app.buttons.closePoints.addEventListener('click', () => toggleModal(app.modals.points, false));
            app.buttons.closeHistory.addEventListener('click', () => toggleModal(app.modals.history, false));
            app.buttons.cancelBehaviors.addEventListener('click', () => toggleModal(app.modals.manageBehaviors, false));
            app.buttons.addNewBehavior.addEventListener('click', () => addBehaviorEditorRow());
            app.buttons.closeParentLink.addEventListener('click', () => toggleModal(app.modals.parentLink, false));
            app.buttons.closeClassSettings.addEventListener('click', () => toggleModal(app.modals.classSettings, false));
            
            // ä¸»é¡Œåˆ‡æ›ç›£è½
            app.buttons.themeToggle.addEventListener('click', toggleTheme);

            if (isTeacherMode) {
                app.buttons.teacherPanel.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    app.containers.controlPanel.classList.toggle('hidden');
                    app.containers.controlPanel.classList.toggle('flex');
                });
                app.buttons.parentLink.addEventListener('click', openParentLinkModal);
                app.buttons.copyParentUrl.addEventListener('click', copyParentUrl);
            } else {
                app.buttons.parentLink.style.display = 'none';
                app.buttons.teacherPanel.style.display = 'none';
                app.buttons.sort.style.display = 'none';
                app.buttons.config.style.display = 'none';
            }
        };

        const setupFirebaseEventListeners = () => {
            if (isTeacherMode) {
                app.buttons.manageStudent.addEventListener('click', openManageStudentModal);
                app.buttons.confirmAddStudent.addEventListener('click', handleAddStudents);
                app.buttons.manageAvatars.addEventListener('click', openAvatarsModal);
                app.buttons.exportGrades.addEventListener('click', () => { playSound(app.sounds.click); toggleModal(app.modals.export, true); });
                app.buttons.resetPoints.addEventListener('click', handleResetPoints);
                app.buttons.manageBehaviors.addEventListener('click', openManageBehaviorsModal);
                app.buttons.saveBehaviors.addEventListener('click', handleSaveBehaviors);
                app.inputs.avatarFile.addEventListener('change', handleAvatarUpload);
                app.buttons.classSettings.addEventListener('click', openClassSettingsModal);
                app.buttons.saveClassSettings.addEventListener('click', handleSaveClassSettings);
                
                app.buttons.exportOriginal.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    const originalOrderStudents = [...state.students].sort((a, b) => {
                        const groupA = a.group || ''; const groupB = b.group || '';
                        if (groupA === groupB) return a.name.localeCompare(b.name, 'zh-Hant');
                        return groupA.localeCompare(groupB, 'zh-Hant');
                    });
                    exportToCsv(originalOrderStudents, `${state.className}_æˆç¸¾(åˆ†çµ„å§“åé †åº).csv`);
                    toggleModal(app.modals.export, false);
                });
                app.buttons.exportSorted.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    const sortedStudents = [...state.students].sort((a, b) => b.points - a.points);
                    exportToCsv(sortedStudents, `${state.className}_æˆç¸¾(åˆ†æ•¸æ’åº).csv`);
                    toggleModal(app.modals.export, false);
                });
                app.buttons.exportLogs.addEventListener('click', handleExportLogs);
                app.buttons.viewHistory.addEventListener('click', () => { playSound(app.sounds.click); toggleModal(app.modals.points, false); openHistoryModal(); });
                app.containers.studentsTab.addEventListener('click', () => { playSound(app.sounds.click); switchTab('students'); });
                app.containers.groupsTab.addEventListener('click', () => { playSound(app.sounds.click); switchTab('groups'); });
                app.buttons.sort.addEventListener('click', () => {
                    playSound(app.sounds.click);
                    const orders = ['byName', 'byPoints', 'byGroup'];
                    const currentOrderIndex = orders.indexOf(state.sortOrder);
                    state.sortOrder = orders[(currentOrderIndex + 1) % orders.length];
                    renderStudentGrid();
                });
            }
        };

        // --- åˆå§‹åŒ–å‡½å¼ ---
        const init = async () => {
            setupFirebaseEventListeners();
            setLoading(true);
            try {
                const configDoc = await db.collection('config').doc('main').get();
                if (!configDoc.exists) {
                    await initializeFirstTimeData();
                }
                // è¨­å®šå³æ™‚ç›£è½å™¨
                state.unsubscribeListeners.forEach(unsub => unsub());
                state.unsubscribeListeners = [];

                const unsubConfig = db.collection('config').doc('main').onSnapshot(doc => {
                    const data = doc.data();
                    if(data) {
                        state.className = data.className || 'Classroom Points!';
                        app.titles.className.textContent = state.className;
                        document.title = state.className;
                    }
                });
                const unsubStudents = db.collection('students').onSnapshot(snapshot => {
                    state.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const hasGroups = state.students.some(s => s.group);
                    if (hasGroups) app.containers.tabsContainer.classList.remove('hidden');
                    else app.containers.tabsContainer.classList.add('hidden');
                    
                    renderStudentGrid();
                    if (!app.modals.manageStudent.classList.contains('hidden')) renderStudentDeletionList();
                    if (!app.modals.manageAvatars.classList.contains('hidden')) renderAvatarGrid();
                    if (state.activeTab === 'groups') renderGroupsGrid();
                    setLoading(false);
                }, error => { console.error("å­¸ç”Ÿè³‡æ–™ç›£è½å¤±æ•—:", error); setLoading(false); });

                const unsubBehaviors = db.collection('behaviors').onSnapshot(snapshot => {
                    state.behaviors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.behaviors.sort((a, b) => a.points - b.points);
                }, error => console.error("è¡Œç‚ºè³‡æ–™ç›£è½å¤±æ•—:", error));

                state.unsubscribeListeners.push(unsubConfig, unsubStudents, unsubBehaviors);
            } catch (error) {
                console.error("åˆå§‹åŒ–æˆ–è¼‰å…¥è³‡æ–™å¤±æ•—:", error);
                setLoading(false);
                app.containers.loadingText.textContent = "Data Link Failed";
                app.containers.setupPrompt.innerHTML = `<p class="mt-4 text-red-300">è«‹æª¢æŸ¥ Firebase è¨­å®šèˆ‡ç¶²è·¯ã€‚</p><p class="text-xs mt-2 text-gray-500">${error.message}</p>`;
                app.containers.setupPrompt.classList.remove('hidden');
                app.containers.spinner.classList.add('hidden');
            }
        };
        
        const initializeFirstTimeData = async () => {
            const batch = db.batch();
            batch.set(db.collection('config').doc('main'), { className: 'æˆ‘çš„ç­ç´š' });
            const defaultBehaviors = [
                { name: "ç©æ¥µåƒèˆ‡", points: 1, type: "positive" }, { name: "å¹«åŠ©åŒå­¸", points: 1, type: "positive" },
                { name: "æº–æ™‚äº¤ä½œæ¥­", points: 2, type: "positive" }, { name: "åœ˜éšŠåˆä½œ", points: 1, type: "positive" },
                { name: "å‰µæ„è¡¨ç¾", points: 2, type: "positive" }, { name: "ä¸Šèª²åˆ†å¿ƒ", points: -1, type: "negative" },
                { name: "æœªäº¤ä½œæ¥­", points: -2, type: "negative" }, { name: "å¹²æ“¾ç§©åº", points: -1, type: "negative" },
                { name: "é²åˆ°æ—©é€€", points: -1, type: "negative" }
            ];
            defaultBehaviors.forEach(b => batch.set(db.collection('behaviors').doc(), b));
            const sampleStudents = [
                { name: "ç‹å°æ˜", points: 0, avatar: generateAvatar("ç‹å°æ˜"), group: "ç¬¬ä¸€çµ„" },
                { name: "é™³å°è¯", points: 0, avatar: generateAvatar("é™³å°è¯"), group: "ç¬¬äºŒçµ„" }
            ];
            sampleStudents.forEach(s => batch.set(db.collection('students').doc(), s));
            await batch.commit();
        };

        // --- å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ ---
        setupStaticEventListeners();

        let db;
        try {
            if (activeConfig) {
                firebase.initializeApp(activeConfig);
                db = firebase.firestore();
                init(); 
            } else {
                // ç„¡è¨­å®šæ™‚çš„ç‹€æ…‹
                throw new Error("No configuration found");
            }
        } catch (e) {
            console.log("ç­‰å¾…è¨­å®šä¸­...");
            app.containers.initialPrompt.classList.remove('hidden');
            app.containers.loadingText.textContent = "Setup Required";
            app.containers.setupPrompt.classList.remove('hidden');
            app.containers.spinner.classList.add('hidden');
        }
    });
    </script>
</body>
</html>